# 人物骨骼贴图功能设计

本文档描述芝绘中「人物骨骼贴图」功能的业务需求与技术实现方案，与功能文档 4.2 人物设计、6.x 漫剧视频设计器衔接。

---

## 1. 功能概述

**人物骨骼贴图** 允许用户为人物（含动物、鸟类等角色）绑定预设骨骼，在画布中通过拖拽骨骼节点形成关键帧，实现角色动画；并支持在设计器人物设置面板中一键应用预设动作（如跑步、跳跃、蹦跳、慢走等）。

---

## 2. 业务需求

### 2.1 人物多角度与筛选

| 需求项 | 说明 |
|--------|------|
| **多角度** | 每个人物可配置**多个角度**（如正面、侧面、背面、3/4 视角等），每个角度对应一套「形象图 + 骨骼绑定」数据。 |
| **Filter Tag** | 每个人物（或每个人物角度）可配置 **filter tag**，用于在素材面板、人物列表等处的筛选与分类（如「主角」「配角」「动物」「Q 版」等）。 |

- 人物列表/人物设计页：展示人物及其角度列表，支持按 tag 筛选。
- 在视频设计器「人物」素材 Tab 中拖入画布时，可先选择「人物 + 角度」，再放置。

### 2.2 人物角度绑定面板

针对**每个人物角度**，可打开一个**骨骼绑定面板**：

| 能力 | 说明 |
|------|------|
| **导入人物图片** | 支持本地上传或从项目素材库选择一张图片，作为该角度的「贴图」来源。 |
| **骨骼预设** | 骨骼为**预设模板**，不手建。预设类型包括：**人物**（参考图片中的 T-pose 等）、**动物**、**鸟**。用户选择一种预设后，画布上显示该预设的骨骼节点与连线。 |
| **拖拽绑定** | 用户通过**拖拽骨骼节点**，将预设骨骼的关节点与人物图片上的对应部位对齐（如头顶、颈、肩、肘、腕、髋、膝、踝等），完成「骨骼-贴图」的绑定关系并持久化。 |

- 绑定结果以「骨骼节点在图片局部坐标/归一化坐标」的形式存储，供画布动画与渲染使用。
- 界面参考：类似「人物图 + 叠加的骨骼节点（如蓝色圆点）+ 骨骼连线（如绿色线段）」的示意图，节点可拖拽移动。

### 2.3 画布中的骨骼动画

| 能力 | 说明 |
|------|------|
| **导入人物** | 用户从素材面板将已绑定骨骼的「人物+角度」拖入**渲染区**（画布），该实例在时间线上以**素材条**形式存在。 |
| **拖拽骨骼成关键帧** | 在画布中选中该人物实例后，可显示其骨骼；用户**拖拽骨骼节点**可改变当前时间点的骨骼姿态，并可**打关键帧**，从而在时间线上形成**骨骼关键帧**序列，实现人物动画。 |
| **一键应用动作** | 在设计器**人物设置面板**（功能面板中当选中人物素材时）中，提供**一键应用动作**：如**跑步、跳跃、蹦跳、慢走**等。应用后自动在时间线上生成对应骨骼关键帧序列（或引用预设动作资源）。 |

- 骨骼关键帧与现有「位置/缩放/旋转」等关键帧并列，但**仅针对带骨骼的人物素材**，且在时间线面板上有**特殊样式**区分（见下文技术方案）。

---

## 3. 技术实现方案

### 3.1 尽量不使用 Canvas 的约定

- **首选方案**：骨骼编辑、绑定面板、画布中的骨骼显示与拖拽，优先采用 **DOM + SVG** 实现：
  - 人物图片：`<img>` 或 `<image>`（SVG 内）定位在容器内。
  - 骨骼节点：**SVG `<circle>`** 或 div + 绝对定位，可拖拽。
  - 骨骼连线：**SVG `<line>`** 或 `<path>`，根据节点坐标实时更新。
- **画布渲染区**：若当前项目画布已采用 DOM（见技术文档 4.1），则人物骨骼层也用 DOM/SVG 叠加在渲染区内；若某处必须用 Canvas（如最终导出合成），则**仅限导出/合成阶段**使用 Canvas，编辑与预览仍以 DOM/SVG 为主。
- **好处**：事件（拖拽、点击）处理简单、与 React 状态/受控组件契合、可复用现有时间线与关键帧逻辑；避免整块画布 Canvas 的坐标换算与重绘成本。

### 3.2 骨骼数据结构（建议）

- **预设骨骼**：每种预设（人物/动物/鸟）对应一份**骨骼拓扑**定义，例如：
  - 节点列表：`id`、显示名、默认相对位置（归一化或相对根节点）、父子关系或连接关系；
  - 连线列表：`fromNodeId`, `toNodeId`。
- **绑定数据**：每个人物角度存一份「骨骼绑定」：
  - 预设类型（人物/动物/鸟）；
  - 贴图资源引用（项目内路径或素材 ID）；
  - 各骨骼节点在该角度贴图上的**绑定位置**（建议归一化 0–1，相对贴图宽高），用于编辑时显示与导出时变形参考。
- **关键帧数据**：在现有关键帧体系上扩展「骨骼姿态」关键帧：
  - 时间 + 各节点相对「绑定位置」的**偏移**（或绝对位置）、可选旋转等；
  - 与「位置/缩放/旋转」等关键帧一样，按时间插值（见 3.5）。

### 3.3 时间线面板中「骨骼关键帧」的特殊样式

- **素材条上**：骨骼关键帧在时间线素材条内以**与普通关键帧不同的样式**展示，便于一眼区分：
  - 形状：例如**小骨架图标**或**双菱形**等，与「位置/缩放/旋转」的钻石形区分；
  - 颜色：使用与「人物/骨骼」语义一致的颜色（如与骨骼连线同色系）；
  - 交互：点击仍可跳转到该时间、选中后可在功能面板中编辑/删除该骨骼关键帧。
- **实现**：在现有时间线轨道与素材条 DOM 结构上（见技术文档 4.4），为「骨骼关键帧」单独一类渲染层或标记 class，应用上述样式。

### 3.4 骨骼运动时人物图片的跟随方式（技术选型）

目标：骨骼在时间轴上运动（关键帧插值）时，**人物图片**要随骨骼「变形」或「跟随」，而不是整张图平移。可选技术路线如下。

暂时先试验 方案 C。

#### 方案 A：矢量/网格变形（Mesh Deformation，无 Canvas 的 DOM 实现）

- **思路**：将人物图片铺在一个**三角网格**上，网格顶点与骨骼节点或骨骼影响权重绑定；骨骼运动时更新顶点位置，用 **CSS/SVG 或 WebGL 的 2D 三角剖分** 对贴图做变形。
- **DOM 友好度**：若使用 **SVG `<feDisplacementMap>`** 或 **CSS clip-path + 多块贴图分区** 近似，可尽量少用 Canvas；但精细网格变形在纯 DOM 下性能与精度有限，通常需要 **WebGL 2D** 或 **Canvas 2D** 做软渲染，与「尽量不用 Canvas」有冲突。
- **结论**：适合作为「中等精度、少量节点」的折中方案；若完全禁止 Canvas，可仅用 SVG 简单变形（如分区扭曲），效果偏简略。

#### 方案 B：骨骼驱动 + 预生成精灵图/序列帧（Sprite / Atlas）

- **思路**：不实时变形贴图，而是根据骨骼动画**预生成**若干帧的**精灵图**（每帧一张裁切好的人物图，或图集 atlas），播放时按时间切换 sprite 帧；骨骼关键帧仅驱动「选哪一帧」或与简单位移/缩放结合。
- **实现**：
  - **离线/预计算**：在绑定阶段或「应用动作」时，用服务端或本地 Node 脚本，根据骨骼姿态序列渲染（如 headless Canvas 或 sharp）出序列帧，再在画布用 DOM `<img>` 或 `<video>` 按时间切换。
  - **或 AI 生成**：用 AI 根据「当前骨骼姿态描述」生成对应姿态的贴图，再组成序列帧；成本与延迟较高，适合后续增强。
- **优点**：画布播放阶段**完全不需要 Canvas**，仅用 DOM + 图片/视频即可；兼容现有导出管线。  
- **缺点**：无法任意拖拽骨骼即兴改姿态，只能播放预设或预生成序列；存储与生成成本较高。

#### 方案 C：实时 2D 骨骼蒙皮（Skinning） + 可选 Canvas/WebGL 仅用于该层

- **思路**：采用经典 2D 骨骼蒙皮——贴图按「骨骼权重」绑定到骨骼，骨骼运动时用**加权变换**计算每个顶点（或像素块）的新位置，再渲染。
- **实现**：精确实现通常需要 **Canvas 2D** 或 **WebGL** 在每一帧重绘变形后的贴图；若产品接受「仅人物骨骼层用一层 Canvas/OffscreenCanvas」，其余仍为 DOM，则可在技术文档中约定「人物骨骼层为 Canvas 层」，其余尽量 DOM。
- **结论**：效果最好、最灵活，但与「尽量不用 Canvas」冲突；若采纳，建议将 Canvas 限制在「人物骨骼实例」的单独一层，并文档化。

#### 方案 D：简化变形（分区 + 仿射变换，DOM/SVG）

- **思路**：将人物按骨骼拆成**若干区域**（如头、躯干、上臂、前臂、手、大腿、小腿、脚等），每块区域用一张图或一张图的裁剪区，绑定到 1～2 根骨骼；骨骼运动时，每块仅做**平移 + 旋转 + 缩放**（仿射），用多个 `<img>` 或 SVG `<use>` + `transform` 拼成整个人物。
- **优点**：**完全 DOM/SVG**，无需 Canvas；实现简单，性能可控。  
- **缺点**：关节处可能有缝隙或重叠，需要美术预留或简单羽化；适合 Q 版、简笔画风格，不适合写实精细变形。

---

**推荐策略（可写入技术文档）**：

1. **短期/首版**：采用 **方案 D（分区 + 仿射）** 或 **方案 B（预设动作对应预生成序列帧）**，保证「尽量不使用 Canvas」且能上线「一键应用动作」与简单骨骼拖拽关键帧。
2. **中期**：若需要更平滑的变形，再引入 **方案 A 的简化版**（如 SVG 分区变形）或 **方案 C**，并明确「人物骨骼层」是否允许单独一层 Canvas/WebGL，在技术文档 4.1 中补充说明。

文档中可保留「矢量自动补帧」与「AI 贴图精灵」作为后续扩展方向：  
- **矢量自动补帧**：对应方案 A/D 的插值（关键帧之间自动插值骨骼姿态，再驱动变形）；  
- **AI 贴图精灵**：对应方案 B 中由 AI 生成各姿态贴图再组成序列帧的方案，作为可选增强。

### 3.5 骨骼关键帧的补间

- 骨骼关键帧之间采用与现有关键帧一致的**时间线性插值**策略（见技术文档 4.4）：根据当前播放时间，对每个骨骼节点的位置（及可选旋转）做插值，得到当前帧的骨骼姿态，再驱动 3.4 中选定的「跟随方式」（变形或序列帧选择）。
- 插值逻辑可放在与 `keyframeTween.ts` 同级的 `skeletonKeyframeTween.ts` 中，输出为「当前时刻各骨骼节点的变换」，供渲染层使用。

### 3.6 与现有模块的衔接

- **人物设计（功能文档 4.2）**：人物列表增加「角度」与「filter tag」配置；每个人物角度增加「骨骼绑定」入口，打开骨骼绑定面板（导入图片 + 选择预设 + 拖拽绑定）。
- **素材体系**：带骨骼的人物作为素材的一种子类型（或人物分类下的增强），素材元数据中记录「是否带骨骼、预设类型、绑定资源路径」等。
- **时间线与功能面板**：选中带骨骼的人物素材时，功能面板展示「骨骼关键帧」与「一键应用动作」；时间线渲染时对骨骼关键帧应用 3.3 的特殊样式。
- **画布**：渲染区中选中该人物实例时，可显示骨骼并支持拖拽骨骼打关键帧；渲染按 3.4 选定方案显示变形或序列帧。

---

## 4. 文档修订说明

- 初版：定义人物多角度与 filter tag、骨骼绑定面板（导入图片 + 预设骨骼 + 拖拽绑定）、画布骨骼关键帧与一键应用动作；技术方案约定尽量 DOM/SVG、时间线骨骼关键帧样式、骨骼驱动贴图的四种方案（矢量/网格、精灵图、实时蒙皮、分区仿射）及推荐策略；与功能文档 4.2、6.x 及技术文档 4.x 衔接。
