# 芝绘 - AI 开发文档

## 1. 目的

本文档面向使用 **AI 开发工具（如 Cursor）** 进行开发的场景，目标是：

- 让 AI 在编写代码、重构、修 Bug 时**严格遵循**《01-功能文档》与《02-技术文档》的约定；
- 让 AI 能够**按模块与 Todo** 执行开发计划，并产出可被**自动测试**或人工验证的交付物。
- 减少歧义、避免偏离产品与技术约束，提高 AI 辅助开发的确定性与可复现性。

---

## 2. 文档优先级与引用方式

### 2.1 优先级

1. **功能文档**：所有界面、交互、业务规则以功能文档为准；若需求描述与代码或注释冲突，以功能文档为准。
2. **技术文档**：技术选型、存储、画布单位、透明视频、视频导出、进程与安全等以技术文档为准。
3. **开发计划**：任务拆分、模块边界、Todo 状态以开发计划为准；AI 接受任务时应先确认所属模块与 Todo 项。
4. **本 AI 开发文档**：约定如何引用上述文档、如何写注释与测试、如何与 Cursor 协作。

### 2.2 在对话中引用

- 向 AI 布置任务时，建议**显式引用**文档与章节，例如：
  - 「请按《01-功能文档》第 6 节实现漫剧视频设计器布局，并遵守《02-技术文档》中 Ant Design 仅 dark 主题与 Splitter 的约定。」
  - 「实现项目级 SQLite 时请遵循《02-技术文档》3.2 与 3.3，表结构设计完成后在《03-开发计划和进度》对应模块下补充 Todo。」
- 在代码或 PR 描述中，可注明「对应功能文档 x.x」「对应技术文档 x.x」，便于回溯。

### 2.3 项目内持久化规则（推荐）

- 在项目根目录或 `docs/` 下维护 **Cursor 规则或 AGENTS 说明**，把「功能文档与技术文档为权威来源」「开发计划为任务来源」写进去，便于 Cursor 在任意会话中加载。
- 示例（可放入 `.cursor/rules` 或项目 README）：
  - 「芝绘项目的需求与约束以 `docs/01-功能文档.md` 和 `docs/02-技术文档.md` 为准；任务以 `docs/03-开发计划和进度.md` 为准；AI 开发约定见 `docs/04-AI开发文档.md`。」

---

## 3. 让 AI 按文档开发的实践

### 3.1 任务拆解

- 给 AI 的任务尽量**单一、可验证**，并指向功能文档的某一节或开发计划的某一 Todo。
- 例如：「实现『剧集场景导航』列表（功能文档 6.3），左侧列默认宽度 240px，可被 Splitter Resize」比「把视频设计器做完」更易被正确执行。开发时以**功能文档 1.1 术语表**为准（舞台、播放器面板、渲染区、时间线、素材条、选中时间轴、素材面板、功能面板、本地素材、预设素材、元件组等）。
- 多步骤任务可拆成多条消息或在一个消息中列出子步骤，并注明对应文档小节。

### 3.2 约束复述

- 在复杂任务开头，可要求 AI **先复述**关键约束再写代码，例如：
  - 「请先列出本任务涉及的功能文档与技术文档要点，再实现 xxx。」
- 有助于减少「忽略横竖屏」「忘记 dark 主题」等遗漏。

### 3.3 禁止与必须

- **禁止**：在未在文档中约定的情况下，引入新的 UI 库、状态管理库或持久化方案；修改功能文档已定的界面布局与交互（除非先更新功能文档）；**通过直接修改 `package.json` 来添加依赖**（必须用 3.4 的 Yarn + 代理流程）。
- **必须**：新功能涉及持久化时，说明写入的是「应用级 SQLite」「项目级 SQLite」还是项目目录下的文件；新 UI 使用 Ant Design 且服从 dark 主题；可 Resize 区域使用 Ant Design Splitter；**AI Chat 相关界面使用 Ant Design X（@ant-design/x、@ant-design/x-markdown、@ant-design/x-sdk）**；添加依赖时必须按 3.4 执行。

### 3.4 添加依赖：Yarn + 代理（Cursor 必须牢记）

- **芝绘项目添加任何 npm 包时，不得直接修改 `package.json`。**
- **正确流程**：先设置代理，再使用 yarn 安装，以保证该版本的包在 registry 上存在且为最新。
  1. 在终端执行：
     ```bash
     export http_proxy=http://127.0.0.1:7897
     export https_proxy=http://127.0.0.1:7897
     yarn add <包名>
     ```
  2. 多包时：`yarn add pkg1 pkg2 pkg3`。
- 此规则已写入技术文档 1.1 与 Cursor 规则（`.cursor/rules`），开发时务必遵守；若用户要求「加一个包」，AI 应回复将执行上述命令并给出具体 `yarn add` 示例，而不是贴出 `package.json` 的 diff。

---

## 4. 代码与注释规范（供 AI 遵循）

### 4.1 注释中引用文档

- 在关键模块、复杂业务逻辑处，注释中注明对应文档，例如：
  - `// 见功能文档 5.2：素材包 YAML 状态与 Tag 映射`
  - `// 见技术文档 4.2：画布坐标使用归一化存储，渲染时换算`
- 便于后续人类或 AI 修改时快速找回依据。

### 4.2 命名与文档一致

- 功能文档中的术语（如「漫剧剧本专家」「漫剧绘画」「剧集场景导航」「选中素材设置」）在代码中尽量一致命名（组件名、路由名、状态键等），避免自创同义不同名导致 AI 或人理解偏差。
- 素材分类名（人物、场景背景、情景道具、声效、透明视频特效、音乐、贴纸）与枚举或常量保持一致。

### 4.3 模块与文件结构

- 目录与模块划分建议与《03-开发计划和进度》中的模块对应（如 `project-list`、`settings`、`outline`、`characters`、`video-designer`、`assets`、`export` 等），便于 AI 按模块定位和修改。
- 新增页面或能力时，在开发计划中补一行 Todo 或状态更新，便于进度跟踪。

---

## 5. 自动测试与 AI 可验证性

### 5.1 测试策略目标

- **可自动运行**：关键路径具备单元测试或集成测试，可在 CI 或本地一键执行，便于 AI 在「修改后跑测试」的循环中验证。
- **与文档对应**：测试描述或用例名能对应到「功能文档 x.x」或「技术文档 x.x」，例如：`describe('项目列表 - 删除策略', () => { ... })` 对应功能文档 2.3。

### 5.2 建议覆盖范围（在开发计划中落实）

- **数据层**：应用级/项目级 SQLite 的初始化、读写、迁移（若有）；YAML 解析与状态/Tag 映射。
- **业务规则**：项目唯一性（本地目录）、删除策略、空场景判定、人物与剧本绑定关系等。
- **导出流水线**：在无 UI 或 Mock UI 下，对「给定场景+时间轴」能否产出预期格式或中间结果进行断言。
- **不强制**：所有 UI 组件都写快照或 E2E（可按优先级在开发计划中排期）。

### 5.3 让 AI 参与测试的方式

- 在布置实现任务时，附带一句：「实现后请补充/运行与本节相关的测试，并确保通过。」
- 项目使用 **Yarn**，测试命令约定为 **`yarn test`**（或 `yarn run test`），在 README 与 Cursor 规则中写明，方便 AI 执行。
- 若使用 Cursor 的「自动测试」或 CI：在仓库中配置好测试命令与入口，修改代码后应运行 `yarn test`，以便 Cursor 在合适时机触发。

### 5.4 测试与文档的同步

- 当功能文档或技术文档发生变更时，对应测试用例应同步更新；在 AI 开发文档中约定「文档变更时，需同步更新相关测试与开发计划」，可减少遗漏。
- AI 若负责更新文档，应在同一次对话中提示「需同步更新 xx 测试或 xx Todo」。

---

## 6. 与 Cursor 的协作清单（可做成 Checklist）

- [ ] 项目内已配置 Cursor 规则或说明，指向功能文档、技术文档、开发计划与本 AI 开发文档，**以及「添加依赖必须 Yarn + 代理」规则**（见 3.4）。
- [ ] 给 Cursor 的任务尽量带「功能文档 x.x / 技术文档 x.x / 开发计划 2.x」引用。
- [ ] 复杂任务前让 Cursor 复述关键约束。
- [ ] 代码注释中对关键逻辑注明文档出处。
- [ ] 术语与文档一致，模块与开发计划对应。
- [ ] **添加包时绝不直接改 package.json，始终先设代理再 `yarn add`。**
- [ ] AI Chat 使用 Ant Design X 三件套（@ant-design/x、@ant-design/x-markdown、@ant-design/x-sdk）。
- [ ] 测试命令为 `yarn test`，关键路径有可自动运行的测试，且测试描述可对应到文档。
- [ ] 文档变更时，同步更新测试与开发计划，并在对话中提醒。

---

## 7. 文档修订说明

- 本文档不包含具体代码或测试代码，仅约定「如何用文档驱动 AI 开发」与「如何通过测试让 AI 验证结果」。
- 若团队引入其他 AI 工具或流程，可在本 AI 开发文档中新增小节，保持「文档优先、任务可引用、测试可自动」的原则即可。
