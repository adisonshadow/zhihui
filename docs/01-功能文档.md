# 芝绘 - 功能文档

## 1. 产品概述

**芝绘** 是一款基于 Electron + React + Ant Design 的桌面应用，用于**快速开发 2D 短漫剧**。用户可在本地管理漫剧项目、编写剧情与人物、使用 AI 辅助创作，并通过漫剧视频设计器完成分镜与导出视频。

---

## 1.1 术语表（视频设计器与素材）

以下术语在功能文档与技术文档中统一使用：

| 原称 / 说明 | 统一术语 | 说明 |
| ----------- | -------- | ----- |
| 画布容器 | **舞台** | 承载渲染区的区域 |
| 画布容器外的面板 | **播放器面板** | 内含舞台与播放控制 |
| 画布 | **渲染区** | 最终渲染出视频的内容区域，尺寸与项目横竖屏一致 |
| 分层与时间轴 | **时间线** | 整体时间线区域 |
| 时间线所在面板 | **时间线面板** | 第三行独立面板，支持高度 Resize |
| 时间线上的长条 | **素材条** | 表示某素材在时间线上的出现区间，可在**时间线轨道**上拖动 |
| 红色竖线 | **选中时间轴** | 表示当前播放/预览对应的时间位置，高度与时间线窗口一致，可水平拖拽跳转 |
| 素材浏览所在面板 | **素材面板** | 列 1，独立于功能面板 |
| 本地添加进来的文件 | **本地素材** | 用户上传或导入的素材 |
| 软件自带的素材 | **预设素材** | 应用内置素材 |
| 从官网下载的素材 | **素材** | 与本地素材、预设素材并列 |
| 设计器中可设计复杂组合、保存成素材前 | **元件组** | 未保存为素材前的组合体 |
| 当前场景 + 选中素材设置 组合 | **功能面板** | 列 3，不含素材面板；素材面板独立 |

**用户习惯持久化**：以下状态自动保存到 **localStorage**，下次打开时恢复：
- 漫剧视频设计器：三个 Toggle（剧集场景、素材面板、AI Chat）的显示/隐藏；
- 项目编辑页：默认选中的 Tab（剧情大纲 / 人物设计 / AI 配置 / 漫剧视频设计器）；
- 漫剧视频设计器内：默认选中的剧集与场景。

---

## 2. 漫剧项目列表

### 2.1 功能说明

- **列表展示**：展示所有漫剧项目，每项显示基础信息。
- **新建项目**：创建新漫剧项目，需填写/选择必要信息；本地项目目录支持**手动输入路径**或点击按钮选择。
- **导入项目**：选择已有项目目录，解析该目录下的 `project.db` 后加入列表；若无法解析则提示导入失败。
- **打开编辑**：进入项目编辑主界面（剧情大纲、人物设计、AI 配置、漫剧视频设计器）。
- **删除项目**：删除项目记录；需明确是仅删除应用内记录，还是同时删除本地项目目录及资源（建议二次确认）。

### 2.2 漫剧信息字段

| 字段         | 说明                                   |
| ------------ | -------------------------------------- |
| 名称         | 漫剧名称，必填                         |
| 横屏/竖屏    | 画布与导出视频的宽高方向               |
| 本地项目目录 | 项目文件与资源所在目录，唯一且不可重复 |
| 封面         | 项目封面图（用于列表展示）             |
| 创建时间     | 自动记录                               |
| 更新时间     | 每次保存/编辑后更新                    |

### 2.3 补充与约定

- 列表支持按名称、创建时间、更新时间排序与简单搜索。
- 删除前需确认，并可选「仅从列表移除」或「同时删除本地目录」。
- 若本地项目目录已被删除或移动，列表项应能标识「路径无效」并支持重新指定路径或移除。

---

## 3. 设置面板

### 3.1 多模态 AI 供应商配置

- **文本**：用于剧本、大纲等文本生成的 API 供应商及必要配置（如 endpoint、apiKey）。
- **生图**：用于人物/场景等图像生成的 API 供应商及配置。
- **生视频**：用于视频生成的 API 供应商及配置。
- **生音频**：用于 TTS、音效、音乐等音频生成的 API 供应商及配置。

每个模态可配置：供应商类型（或自定义）、API 地址、密钥、模型名等（具体字段在技术实现时按供应商 API 定义）。

### 3.2 后续可扩展

- 代理设置、语言/地区、快捷键、主题等可留入口，本版仅实现多模态 AI 供应商配置。

---

## 4. 漫剧编辑

漫剧编辑包含四个主模块：**剧情大纲**、**人物设计**、**AI 配置**、**漫剧视频设计器**。四者共享同一项目上下文（项目信息、素材分类、AI 配置等）。Tab 栏左侧为「返回项目列表」与项目名，右侧为「设置」入口。

### 4.1 剧情大纲

- **布局**：左侧集列表（默认 200px）、中间概要/剧本编辑、右侧漫剧剧本专家 Chat（默认 320px），使用 Splitter 可拖拽调整宽度。
- **按集划分**：每集有标题、顺序、可选摘要。
- **概要/剧本内容**：每集可编辑剧情概要及详细剧本文本。
- **AI 漫剧剧本专家 Agent Chat**：
  - 在界面提供专用 Chat 区域，与「漫剧剧本专家」Agent 对话。
  - 支持基于当前大纲/剧本进行生成、修改、扩写、缩写等。
  - 生成或修改的结果可一键或选择性地写回对应集的概要/剧本。

### 4.2 人物设计

- **布局**：左侧人物列表（默认 240px）、右侧人物编辑，使用 Splitter 可拖拽调整宽度。
- **人物列表**：管理本漫剧中所有角色（含动物等，统一归为「人物」）。
- **人物信息**：名称、形象资源（图片/资源包引用）、备注等。
- **形象来源**：
  - 本地上传或从项目素材库选择。
  - 使用 **AI 漫剧绘画 Agent** 生成形象，生成结果可保存为项目素材并绑定到该人物。
- **默认 TTS 参数**：每个人物可配置一套默认 TTS 参数（如音色、语速、语调等），在视频设计器中为该人物添加对白时可默认带出。

### 4.3 AI 配置（项目级）

- **漫剧剧本专家**：本项目下对剧本专家的自定义要求/系统提示（如风格、篇幅、角色设定等）。
- **漫剧绘画**：本项目下对绘画 Agent 的自定义要求（如画风、线稿/上色偏好等）。
- 与全局「设置面板」中的多模态供应商配置区分：此处仅负责「本项目内」的 prompt/偏好，不涉及 API 密钥等。

### 4.4 漫剧视频设计器

视频设计器是分镜与成片制作的核心界面，详见第 5 节。

---

## 5. 素材体系

### 5.1 素材唯一分类

每个漫剧项目内，素材按**唯一分类**管理，分类包括：

| 分类           | 说明与示例                           |
| -------------- | ------------------------------------ |
| 人物           | 角色形象，动物等也归入此类           |
| 场景背景       | 山水、天空、室内等背景图/视频        |
| 情景道具       | 马车、桌椅等可与剧情联动的道具       |
| 声效           | 音效文件                             |
| 透明视频特效   | 带透明通道的视频特效                 |
| 音乐           | 背景音乐等                           |
| 贴纸           | 静态或简单动效贴纸                   |

### 5.2 素材来源与元件组

- **本地素材**：用户本地上传或导入到项目中的文件。
- **预设素材**：软件自带的素材。
- **素材**（狭义）：从官网下载的素材；与本地素材、预设素材并列。
- **元件组**：在设计器中可设计复杂组合并方便复用的对象，在**保存成素材前**称为元件组；保存后归入上述分类。

### 5.3 素材包（Package）

- 一种特殊素材形态：一个 **Package** 对应一个资源包目录，内含：
  - 若干资源文件（图、视频、音频等）；
  - 一个 **YAML 描述文件**，用于声明：
    - 素材基本信息（名称、分类、描述等）；
    - **状态** 与 资源组/资源/唯一素材 ID 的对应（如道具「马车」：状态「行驶中」→ 某资源，「停止」→ 某资源）；
    - **Tag** 与 资源组/资源/唯一素材 ID 的对应（便于筛选与批量引用）。
- 在**舞台**或**时间线**中使用「带状态的素材」时，通过切换状态或配合关键帧，可在不同时间点展示不同形态（如马车从行驶中变为停止）。

---

## 6. 漫剧视频设计器界面

### 6.1 整体布局（宽度适配窗口）

- **第一行（固定高度）**
  - 左侧：Undo、Redo（**不包含返回**，返回在项目编辑页 Tab 栏）。
  - 中间：项目名、当前集名；切换按钮组：**剧情大纲**、**人物设计**、**AI 配置**、**漫剧视频设计器**。
  - 右侧：全集播放、全部播放、导出视频；三个 Toggle：显示/隐藏「剧集场景」、显示/隐藏「素材面板」、显示/隐藏「AI Chat」。以上 Toggle 与默认剧集/场景、项目编辑页默认 Tab 均**持久化到 localStorage**。
- **第二行（占满第一行以下的视口高度）**
  - 使用 **Splitter** 分为 **3 列**（列宽可 Resize）：
    - **列 1**：**素材面板**（原「素材浏览」），人物/特效/声效/音乐等 Tabs，可 Resize 宽度。
    - **列 2**：**播放器面板**，内含**舞台**（原「画布容器」）与**渲染区**（原「画布」），可 Resize 列宽。
    - **列 3**：**功能面板**（当前场景 + 选中素材设置，以手风琴形式），可 Resize 列宽。**素材面板独立，不归于功能面板。**
- **第三行**
  - **时间线面板**（原「分层与时间轴」所在区域），独立一行，支持**高度 Resize**；内含分层列表与**时间线**（时间尺 + 轨道 + 素材条 + 选中时间轴）。

### 6.2 顶部功能 Panel（第一行）

- 集名称展示与切换（或与剧集场景导航联动）。
- Undo / Redo。
- 全集播放：当前集从头到尾预览。
- 全部播放：全部集顺序播放（具体范围可约定为当前集或全项目）。
- 导出视频：将当前集或选定集导出为视频文件。

### 6.3 剧集场景导航

- 以列表或卡片形式展示「集 → 场景」结构；默认选中**上次打开的**集/场景（持久化到 localStorage）。
- **空场景**（无任何内容或未编辑）用偏淡文字或样式区分。
- 每集支持鼠标悬停或选中时出现「全集播放」入口。

### 6.4 素材面板（列 1）

- **Tab：人物**
  - 若 AI 生成剧本时已绑定人物，则将这些人物排在最前，并用分割线与「未绑定人物」分开。
- **Tab：特效素材**
- **Tab：声效素材**
- **Tab：音乐素材**  
（其他分类如场景背景、情景道具、贴纸等可按需以 Tab 或分组形式放入；**本地素材**、**预设素材**、官网下载的**素材**区分见术语表 1.1。）

- **素材放置方式**：
  - 点击素材旁的「**放置**」按钮：默认放到**主轨道**当前**选中时间轴**对应位置；若该位置主轨道已有素材，则**插入**：将已有素材及后续素材依次后移，再插入新素材。
  - 素材可**拖拽**到**舞台**（渲染区点击放置）、或**拖拽到时间线**并创建素材条。
- **默认播放时长**：图片类（无播放时长的素材）放置时默认 **10 秒**，音视频等默认 5 秒；**本地素材**图片放置时同样默认 10 秒。

### 6.5 播放器面板与舞台、渲染区

- **播放器面板**：列 2，包裹**舞台**与播放控制。
- **舞台**（原「画布容器」）：承载**渲染区**及「尚未完全置入」的溢出内容（视「显示/隐藏超出内容」开关而定）。
- **渲染区**（原「画布」）：最终渲染出视频的内容区域；尺寸与项目「横屏/竖屏」一致，内里素材可选中、拉伸、旋转。**时间轴变化时**（无论播放还是拖拽选中时间轴）：渲染区按**当前时间**显示该帧下关键帧插值后的效果（如位置、缩放、旋转、透明度、模糊等）。
- 播放器面板上方功能：**播放/停止**（播放时**时间轴按播放进度向右移动**）、放大/缩小、**添加**（背景/前景特效等）、显示/隐藏超出内容、**添加本地素材**（上传后选类型/常用/描述）。

### 6.6 功能面板（列 3，手风琴）

- **当前场景**：播放速度、镜头（x/y/z、AI 自动生成镜头、自动居中说话人物）等。
- **选中素材设置**（选中时显示）：信息与素材自带设置、播放时间、对象运动（x/y/z、缩放、旋转）及**关键帧**（见 6.8）。

### 6.7 时间线面板与时间线

- **时间线面板**：第三行独立面板，支持**高度 Resize**；内含**分层**列表与**时间线**。
- **主分层（主轨道）**：设计器每次设计一个场景，**初始化场景后自动创建 1 个主分层**，该分层即为**主分层**（对应**主轨道**）。主分层**不可删除**；主分层下的轨道**支持 sortable**（水平排序）；**其他分层不支持 sortable**（仅支持 draggable）。主分层与显示顺序无关（不是「最上面一个」即主分层）。
- **分层**：
  - 列出当前场景下所有素材层，每层可显示/隐藏、锁定。
  - 支持拖拽排序改变 z-index（上下顺序即前后关系）。
- **轨道规则**：
  - **主轨道**：素材不可叠加，相邻素材**不可有空隙**；调整某素材的播放时间时，**后续素材自动跟随**变化。
  - **非主轨道**：素材可**自由 drag/drop**，**只要不重叠**即可，允许有空隙。
- **时间线**：
  - **时间尺**：时间线轨道最上方，显示时间刻度。
  - **时间线轨道**：每条轨道对应一个分层，其上为**素材条**，表示该素材在时间线上的出现区间。
  - **素材条**：可**选中、删除、左右 Resize**（对应起止播放时间）、**跨分层拖拽**（drag/drop）。
  - **选中时间轴**（原「红色竖线」）：高度与时间线窗口一致，表示当前播放/预览对应的时间位置；可**按住水平拖拽**，拖拽后播放器跳转并停止到该时间；鼠标悬停为**左右箭头**（ew-resize）；**点击素材条或关键帧时，不移动选中时间轴的位置**。
- **素材条拖拽体验**：
  - 素材条拖拽到轨道上时有 **ghost 区域**显示。
  - 素材条拖拽到**两个轨道之间**可**创建新分层和轨道**。
  - 素材条从一个轨道拖到另一轨道时：若原轨道**无任何素材且非主轨道**，则**自动删除**该分层和轨道；若拖到**最上/最下**轨道之上或之下，则仍创建新分层和轨道。
- **关键帧**：**按属性独立**（位置、缩放、旋转、模糊、透明度、色彩等各自独立）。关键帧操作的对象包括：**位置 / 平面旋转 / 3D 旋转 / 缩放**（在渲染时使用一个 **Transform** 组合）、**模糊 / 透明度 / 色彩**。关键帧之间按时间**补间过渡**（线性插值）；位置/平面旋转/3D旋转/缩放由同一套变换组合输出。仅在**功能面板**「位置大小」等各参数旁提供**关键帧按钮**（钻石形 + 左右箭头）。关键帧按钮：时间轴未与素材条重叠时置灰；可添加时提示「添加关键帧」；有关键帧时钻石有颜色，提示「删除关键帧」。左右箭头跳转该属性的上一个/下一个关键帧。**素材条上关键帧**：仅**选中**素材条时显示；符号为 45° 旋转的方形（钻石）；时间轴与关键帧 x 轴差距小于 10px 时自动对齐并选中。

### 6.8 选中素材设置（功能面板内，选中时显示）

当在**舞台**或**时间线**选中某素材时，**功能面板**内展示「选中素材设置」：

- **信息与素材自带设置**
  - 展示素材名称、类型、来源等基础信息。
  - 若素材带**状态**（如情景道具「马车」的行驶中/停止），可在此切换状态；配合关键帧可在不同时间点使用不同状态。
- **播放时间**
  - 显示开始时间、结束时间；可编辑**播放时长（秒）**并应用，用于调整该素材在时间线上的持续时间。
- **对象运动（位置大小）**
  - 缩放、等比缩放、位置（X/Y）、旋转；各参数旁有**关键帧按钮**（钻石形 + 左右箭头）。关键帧按属性独立（位置/缩放/旋转/模糊/透明度/色彩等各自独立）。**修改自动保存**，无需保存按钮。时间轴未在素材条上时按钮置灰；有关键帧时钻石有颜色；左右箭头跳转该属性的上一个/下一个关键帧。**选中关键帧时**：在画布中拖拽该素材的**位置**（或后续支持的旋转/缩放）时，功能面板中对应数字与关键帧存储的值会同步更新。

---

## 7. 与 AI 的协作方式（汇总）

- **设置面板**：配置多模态（文本、生图、生视频、生音频）的 AI 供应商，全局生效。
- **项目内 AI 配置**：配置本项目下「漫剧剧本专家」「漫剧绘画」的自定义要求。
- **剧情大纲**：通过「AI 漫剧剧本专家」Agent Chat 生成/修改概要与剧本，并可与人物绑定（供人物 Tab 排序）。
- **人物设计**：通过「AI 漫剧绘画」Agent 生成形象，并支持每人默认 TTS 参数。
- **视频设计器**：镜头支持「AI 自动生成镜头」；人物可绑定剧本，用于「自动居中说话人物」等后续能力。

---

## 8. 文档修订说明

- 对「漫剧项目列表」补充了排序、搜索与删除策略。
- 新增**导入项目**（选择目录、解析 project.db）、**本地项目目录可手动输入**。
- 对「设置面板」明确仅先做多模态 AI 供应商配置。
- 对「剧情大纲」「人物设计」「AI 配置」与「视频设计器」的职责做了边界划分。
- 项目编辑页 Tab 栏：左侧返回列表+项目名，右侧设置入口；剧情大纲、人物设计采用 **Splitter** 可调宽度布局（剧情大纲左 200px/右 320px，人物设计左 240px）。
- 对素材分类与 Package YAML 做了结构化描述。
- **术语表（1.1）**：统一**舞台 / 播放器面板 / 渲染区 / 时间线 / 时间线面板 / 素材条 / 选中时间轴 / 素材面板 / 功能面板 / 本地素材 / 预设素材 / 元件组**；**用户习惯持久化**（localStorage：设计器 Toggle、项目编辑默认 Tab、设计器默认剧集与场景）。
- **视频设计器布局**：第一行移除返回；第二行 **3 列**（素材面板、播放器面板、功能面板），第三行**时间线面板**（高度可 Resize）；素材面板与功能面板独立。
- **时间线**：素材条可选中、删除、左右 Resize、跨分层拖拽；时间尺在轨道最上方；选中时间轴全高可拖拽跳转；**关键帧仅在功能面板创建/删除**，素材条上显示关键帧并可点击跳转、删除键或参数旁按钮删除。
- 素材放置：**图片类默认播放 10 秒**，其他 5 秒；**选中素材设置**中可显示并编辑**播放时间**（时长秒数）。
- **素材与时间线应用习惯**：场景初始化后自动创建主分层（主轨道）；主分层不可删除，仅主轨道支持 sortable；素材点「放置」默认放到主轨道；拖拽可创建层、空非主轨道自动删除；素材条拖拽有 ghost 区域。
- **选中时间轴**：悬停为左右箭头；点击素材条或关键帧不移动时间轴位置。
- **关键帧效果**：关键帧操作对象包括位置/平面旋转/3D旋转/缩放（统一为一个 Transform）、模糊/透明度/色彩；关键帧之间补间过渡；选中关键帧时画布上修改素材位置等会同步到面板与关键帧；播放时时间轴随进度移动，渲染区按当前时间渲染关键帧插值结果。
- 未涉及具体实现细节（如画布用 Canvas 还是 DOM、导出是否用 ffmpeg），留待技术文档与开发计划中约定。

如你有新增场景或字段需求，可直接在本文档中追加小节或表格，再同步到技术文档与开发计划。
