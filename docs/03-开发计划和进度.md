# 芝绘 - 开发计划和进度

## 1. 说明

- 本文档在**功能文档**与**技术文档**经确认后填写具体任务与进度。
- 采用**按模块划分**的 Todo List 形式，便于拆任务、排期与跟踪。
- 每个模块下列出子项，子项可标状态：未开始 / 进行中 / 已完成。
- **技术约束**：Vite 构建、Yarn 包管理、Ant Design 仅 dark 主题、AI Chat 用 Ant Design X 三件套；添加包必须「先设代理再 yarn add」，禁止直接改 package.json。参考项目：`/Users/yanfang/dev/Biezhi2/web`（路由、Ant Design 主题、Tailwind 配置）。

---

## 2. 模块划分与 Todo

### 2.1 工程与基础

- 脚手架：Electron + React + Vite + Ant Design 工程初始化、Vite 与 electron-builder 配置。
- 主题：Ant Design 仅 dark 主题（ConfigProvider + theme.darkAlgorithm），参考 Biezhi2/web 的 main 入口与 customTheme。
- Tailwind：Tailwind v4 + PostCSS（@tailwindcss/postcss），tailwind.config.ts、index.css 中 @import "tailwindcss"。
- 应用级 SQLite：首次启动初始化、表结构设计、主进程读写 API。
- 主进程与渲染进程通信：预加载脚本、contextBridge、IPC 命名与安全约定。

**Todo：**

- [x] 使用 Vite 模板创建 Electron + React 项目，配置 electron-builder 与多入口（主进程 / 渲染进程）。
- [x] 接入 Ant Design、配置 dark 主题与 zh_CN locale（参考 Biezhi2/web/main.tsx）。
- [ ] 接入 Tailwind v4（postcss.config.js、tailwind.config.ts、index.css），与 Ant Design 共存。
- [x] 应用级 SQLite：选定库（如 better-sqlite3）、定义存储路径、设计 projects 等表、暴露 IPC API。
- [x] 预加载脚本与 contextBridge：仅暴露约定的 API，禁止暴露 Node/Electron 全量。
- [x] 配置 Yarn 与脚本（dev/build/test）；添加依赖时一律使用「代理 + yarn add」。

---

### 2.2 漫剧项目列表

- 列表展示、新建、打开、删除（含删除策略与确认）。
- 项目信息字段的持久化与展示（名称、横竖屏、本地目录、封面、创建/更新时间）。
- 列表排序、搜索（可选）；无效路径检测与提示。

**Todo：**

- [x] 项目列表页：从应用级 SQLite 读取并展示，支持按名称/时间排序与简单搜索。
- [x] 新建项目：表单（名称、横竖屏、本地目录、封面），校验目录唯一性，写应用级 SQLite 并创建项目目录与项目级 SQLite（见 2.4）。
- [x] 打开项目：校验路径存在，跳转至漫剧编辑（路由或窗口约定）。
- [x] 删除项目：二次确认；可选「仅从列表移除」或「同时删除本地目录」；更新 SQLite。
- [x] 无效路径：列表项标识路径无效，支持重新指定或移除。

---

### 2.3 设置面板

- 多模态 AI 供应商配置（文本、生图、生视频、生音频）的 UI 与持久化。
- 与各 AI 能力的对接预留（密钥、endpoint、模型等）。

**Todo：**

- [x] 设置页/抽屉：四个模态的配置表单（供应商类型、API 地址、密钥、模型名等），持久化到应用配置目录（不提交版本库）。
- [x] 提供读取配置的 API（主进程或 contextBridge），供剧情大纲、人物设计、视频设计器内 AI 调用时使用。

---

### 2.4 项目级数据与目录

- 新建项目时创建项目目录与项目级 SQLite。
- 项目级 SQLite 表结构设计（大纲、人物、AI 配置、场景、分层、时间轴、素材索引等）。
- 项目资源目录结构约定与读写 API。

**项目目录结构约定**（见技术文档 3.3）：项目根目录下：
- `project.db`：项目级 SQLite 数据库。
- `assets/`：素材文件（人物、场景、声效等）。
- `exports/`：导出视频等输出。
- `ai-cache/`：AI 生成缓存。

**Todo：**

- [x] 项目目录结构约定：如 `assets/`、`exports/`、`ai-cache/` 等，写入技术文档或本计划。
- [x] 项目级 SQLite 表设计：project_meta、episodes、outline、characters、ai_config、scenes、layers、timeline、assets_index 等，与功能文档对应。
- [x] 主进程/API：根据项目路径打开或创建项目库，提供 CRUD 与事务封装；渲染进程通过 IPC 调用。
- [x] 新建项目流程中调用「创建项目目录 + 初始化项目库 + 写入首条 project_meta」。

---

### 2.5 剧情大纲

- 按集划分的 UI、集的新增/删除/排序。
- 概要、剧本文本编辑。
- AI 漫剧剧本专家 Agent Chat 区域与对话逻辑，结果写回大纲/剧本；与人物绑定的关联（供视频设计器人物 Tab 排序）。

**Todo：**

- [x] 剧情大纲页：集列表（可增删排序）、每集下概要 + 剧本文本编辑，持久化到项目级 SQLite。
- [x] 集成 Ant Design X 三件套：在本页提供「漫剧剧本专家」Chat 区域（@ant-design/x + x-markdown + x-sdk），对接设置中的文本 API；支持将生成结果写回当前集概要/剧本。
- [x] 人物绑定：剧本中若引用人物（约定格式或标记），在数据结构中记录，供视频设计器「人物」Tab 排序（绑定人物排前 + 分割线）。

---

### 2.6 人物设计

- 人物列表、人物信息编辑（名称、形象、备注）。
- 形象来源：本地上传、从素材库选择；AI 漫剧绘画 Agent 生成并保存、绑定人物。
- 每人默认 TTS 参数配置与存储。

**Todo：**

- [x] 人物设计页：人物列表 CRUD、每人名称/形象引用/备注、默认 TTS 参数表单，持久化到项目级 SQLite。
- [x] 形象来源：本地上传（写入项目 assets）、从项目素材库选择（人物/场景等分类）。
- [ ] AI 漫剧绘画：调用设置中的生图 API + 项目级 AI 配置中的绘画要求，生成结果可保存为项目素材并绑定到当前人物。（当前为占位「开发中」）
- [x] TTS 参数：字段设计（音色、语速等），存项目库，供视频设计器中对白默认带出。

---

### 2.7 AI 配置（项目级）

- 剧本专家、绘画的自定义要求/系统提示的编辑与保存。
- 与全局设置中的 API 配置区分与合并使用方式。

**Todo：**

- [x] 项目内「AI 配置」页/区块：两个文本区（剧本专家自定义要求、绘画自定义要求），保存到项目级 SQLite。
- [x] 调用剧本专家/绘画时：合并「全局 API 配置」与「项目级自定义要求」，在请求中传入。

---

### 2.8 素材体系

- 素材分类与项目内素材库索引（人物、场景背景、情景道具、声效、透明视频特效、音乐、贴纸等）。
- 素材包（Package）目录与 YAML 解析：元信息、状态映射、Tag 映射。
- 素材的增删改查、类型选择、常用标记、描述等；本地素材上传与「保存为常用」流程。

**Todo：**

- [x] 素材分类枚举与项目内 assets_index 表（或等价）设计，支持类型、路径、常用、描述等。
- [x] 素材包：解析目录内 YAML（js-yaml），读取元信息、状态→资源、Tag→资源；缓存到项目库或内存，YAML 变更可刷新。
- [x] 素材库 UI：按分类筛选、列表/卡片、上传入口；上传弹窗：选择类型、是否常用、描述（可选），写入项目目录与 assets_index。
- [x] 「保存为常用」：标记写入，在素材浏览等处可过滤「常用」。

---

### 2.9 漫剧视频设计器 - 布局与导航（术语见功能文档 1.1）

- 整体布局：第一行固定（**不含返回**）；第二行 **3 列** Splitter（素材面板、播放器面板、功能面板）；第三行**时间线面板**（高度可 Resize）。
- 顶部功能：Undo/Redo、剧名/集名、全集播放、全部播放、导出视频、三个 Toggle（剧集场景、素材面板、AI Chat）。**用户习惯持久化**：上述 Toggle、项目编辑默认 Tab、设计器默认剧集/场景写入 localStorage。
- 剧集场景导航：集/场景列表、默认选中上次打开（持久化）、空场景样式、全集播放入口。

**Todo：**

- [x] 视频设计器路由/页面：第一行固定高度，左侧 Undo/Redo、中间剧名/集名、右侧全集播放/全部播放/导出视频 + 三个 Toggle（**第一行移除返回**）。
- [x] 第二行：Ant Design Splitter 四列（剧集场景、画布+时间轴、手风琴、AI Chat）；列宽可 Resize。（**待改为 3 列：素材面板、播放器面板、功能面板**。）
- [ ] **布局调整**：第二行改为 3 列（素材面板、播放器面板、功能面板）；第三行独立时间线面板，高度可 Resize。
- [ ] **localStorage**：设计器 Toggle（showNav/showAssets/showChat）、项目编辑默认 Tab（activeKey）、设计器默认剧集/场景（selectedEpisodeId/selectedSceneId）读写 localStorage。
- [x] 剧集场景导航：从项目级数据拉取集/场景，默认选中上次打开；空场景文字偏淡；每集悬停/选中显示「全集播放」。

---

### 2.10 漫剧视频设计器 - 播放器面板与舞台、渲染区（术语见功能文档 1.1）

- **播放器面板**：列 2，内含**舞台**（原画布容器）、**渲染区**（原画布）；实现方式选型（Canvas 或 DOM）；尺寸与横竖屏；坐标与单位（归一化/百分比，渲染时换算）。
- 渲染区内素材：选中、拉伸、旋转；舞台：溢出显示/隐藏、缩放、播放/停止。
- 播放器面板上方：添加（背景、前景特效、场景运动）、添加**本地素材**及弹窗（类型、常用、描述）。

**Todo：**

- [x] 画布选型：DOM 或 Canvas，需支持透明视频；画布尺寸与项目横竖屏一致；素材位置/缩放/旋转用归一化或百分比存储，渲染时换算为 px。
- [x] 画布内素材：选中态、拖拽改变位置与尺寸、旋转手柄或属性；数据与当前场景分层/时间轴同步。
- [x] 画布容器：视口缩放、播放/停止当前场景预览；Toggle 显示/隐藏超出画布内容。
- [x] 画布上方 Panel：添加下拉、「添加本地素材」打开弹窗，写入项目素材与当前场景。

---

### 2.11 漫剧视频设计器 - 时间线面板与时间线（术语见功能文档 1.1）

- **时间线面板**：第三行独立，高度可 Resize；内含**分层**列表与**时间线**（时间尺 + 轨道 + **素材条** + **选中时间轴**）。
- 分层：显示/隐藏、锁定、拖拽排序（z-index）。**时间线**：**时间尺**在轨道最上方；**素材条**（原素材块）可**选中、删除、左右 Resize**（起止时间）、**跨分层拖拽**；**选中时间轴**（原红色竖线）高度与时间线窗口一致，可**水平拖拽**跳转，拖拽后播放器跳转并停止到该时间。
- **关键帧**：**不在时间线上创建**；仅在**功能面板**中，在具备「创建关键帧」的参数旁（如 x 位置后）提供创建按钮；**素材条上可显示关键帧**，点击跳转到对应面板与参数；删除键或参数旁「取消关键帧」可删除。

**Todo：**

- [x] 分层列表：当前场景下所有层，每层可显示/隐藏、锁定；支持拖拽排序更新 z-index；与画布渲染顺序一致。
- [x] 时间轴：轨道与素材块、红色竖线表示当前播放时间；某素材有关键帧时显示关键帧标记；底部 Panel：时间轴缩放、宽松/紧凑模式。
- [x] **时间线优化**：时间尺在轨道最上方；素材条可选中、删除（Delete 键）、左右 Resize（边缘拖拽）、跨分层拖拽；选中时间轴全高可水平拖拽跳转；**移除时间线上的「添加关键帧」**，关键帧仅在功能面板创建/删除；素材条上显示关键帧、点击跳转、参数旁「取消」按钮删除。
- [x] **素材与时间线应用习惯**（见功能文档 6.4/6.7）：时间线默认 1 个主轨道；素材点「放置」放到主轨道当前时间轴位置、有冲突则插入后移；素材可拖拽到时间线创建素材条；主轨道无叠加无空隙、调整时长后续素材自动跟随；非主轨道可自由 drag/drop、只要不重叠即可；轨道 position absolute 布局、关键帧在条内用 %；拖拽 ghost、跨轨道可删空非主轨道。
- [x] 当前场景（功能面板内）：播放速度设置；镜头：启用后新增镜头层、x/y/z 偏移、「AI 自动生成镜头」按钮、「自动居中说话人物」勾选，数据落库。

---

### 2.12 漫剧视频设计器 - 素材面板与功能面板（术语见功能文档 1.1）

- **素材面板**（列 1，独立）：Tabs 人物（绑定优先+分割线）、特效、声效、音乐等；**本地素材**/预设素材/官网素材区分；拖拽或点击放置到舞台。
- **功能面板**（列 3，不含素材面板）：当前场景 + 选中素材设置（手风琴）。选中素材设置：信息与素材自带设置（含状态切换）、播放时间、对象运动（x/y/z；**每个可打关键帧的参数旁有「创建关键帧」按钮**）、过渡效果；关键帧仅在功能面板创建/删除。

**Todo：**

- [x] 素材浏览（手风琴内）：Tabs 为人物/特效/声效/音乐等；人物 Tab 中绑定剧本的人物排前 + 分割线；支持拖拽或点击放置到画布，生成新层与时间轴块。
- [x] **术语与布局**：素材面板独立为列 1；功能面板为列 3（当前场景 + 选中素材设置）；关键帧仅在功能面板创建，素材条上仅显示关键帧并可点击跳转/删除。
- [x] 选中素材设置（功能面板内）：画布或时间轴选中某素材时显示；信息与素材自带设置、播放时间、对象运动（x/y/z、关键帧、过渡效果），与时间轴关键帧联动。
- [x] **关键帧效果**：关键帧操作对象含位置/平面旋转/3D旋转/缩放（统一 Transform）、模糊/透明度/色彩；新文件实现关键帧间补间；选中关键帧时画布改位置等同步到面板与关键帧；播放时时间轴随进度移动，画布按当前时间渲染关键帧插值（位置、透明度等）。

---

### 2.13 视频导出

- 导出流水线：帧序列 + 音频生成，ffmpeg 调用或替代方案；透明视频素材参与合成；导出格式/分辨率/帧率；导出进度与结果路径。

**Todo：**

- [x] 导出流水线设计：按当前场景时间轴与分层生成帧序列；主进程 Sharp 合成单帧、fluent-ffmpeg 编码 MP4；当前仅支持图片素材（character/scene_bg/prop/sticker），视频素材后续扩展。
- [x] 导出选项：格式 MP4、分辨率（1920×1080/1080×1920 可选）、帧率（24/30）；导出进度条与完成后的结果路径展示；可复制路径、在文件夹中显示。
- [x] ffmpeg 分发：优先使用 `ffmpeg-static` 内置二进制（若已安装）；否则使用系统 PATH 的 ffmpeg，需用户自行安装。

---

### 2.14 AI Chat 集成（视频设计器内）

- 列 4 的 AI Chat 区域与 Toggle；与剧本专家/绘画等 Agent 的调用入口与上下文传递。

**Todo：**

- [ ] 视频设计器列 4：使用 Ant Design X 三件套实现 AI Chat 区域，可通过顶部 Toggle 显示/隐藏。
- [ ] 与剧本专家/绘画的对接：传入当前项目/集/剧本或选中人物等上下文，调用设置中的 API + 项目级 AI 配置；若与剧情大纲 Chat 复用逻辑，可抽公共 hook 或 service。

---

### 2.15 测试与质量

- 关键路径的单元测试或集成测试（SQLite、YAML、导出等）；自动化测试策略与 CI 占位。

**Todo：**

- [ ] 数据层测试：应用级/项目级 SQLite 初始化与 CRUD；YAML 解析与状态/Tag 映射。
- [ ] 业务规则测试：项目目录唯一性、删除策略、空场景判定、人物绑定等（可按模块写 describe）。
- [ ] 导出流程测试：Mock 场景与时间轴，断言产出格式或中间结果（若可行）。
- [ ] 配置 `yarn test` 与测试框架（如 Vitest），README 与 Cursor 规则中写明；CI 占位可选。

---

## 3. 进度记录

- 计划开始时间：（待填）
- 当前阶段：2.11 时间线优化、2.12 术语与布局已完成；下一步：2.13 视频导出 或 2.14 AI Chat 集成
- 里程碑与完成时间：（随开发填写）

---

**依赖与参考**：功能文档 `docs/01-功能文档.md`；技术文档 `docs/02-技术文档.md`（Vite、Yarn、Ant Design X、参考项目 Biezhi2/web）；AI 开发文档 `docs/04-AI开发文档.md`（Yarn+代理、测试命令 `yarn test`）。开发启动见 `docs/05-开发启动指引.md`。
