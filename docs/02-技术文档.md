# 芝绘 - 技术文档

## 1. 技术栈总览

| 层次       | 选型              | 说明                           |
| ---------- | ----------------- | ------------------------------ |
| 桌面壳     | Electron          | 跨平台桌面应用，主进程 + 渲染进程 |
| 前端框架   | React             | UI 与状态管理                  |
| 构建工具   | Vite              | 开发与生产构建                 |
| 包管理     | Yarn              | 依赖安装与脚本；添加包方式见本文档 1.1 |
| UI 组件库  | Ant Design        | 仅使用 dark 主题               |
| 布局组件   | Ant Design Splitter | 可拖拽调整宽高的多列/多行布局   |
| AI 对话 UI | Ant Design X      | AI Chat 使用，含 3 个包（见 1.2） |
| 本地数据库 | SQLite            | 应用级 + 项目级                |
| 打包        | electron-builder（与 Vite 配合） | 在开发计划中落实 |

### 1.1 添加依赖的强制规则（Yarn + 代理）

- **禁止**：AI 或开发者**不得**通过直接修改 `package.json` 来添加依赖。
- **必须**：添加任何新包时，先执行代理环境变量，再使用 yarn 安装，以保证该版本在 registry 上存在且为最新：
  ```bash
  export http_proxy=http://127.0.0.1:7897
  export https_proxy=http://127.0.0.1:7897
  yarn add <包名>
  ```
- 多包可合并为：`yarn add pkg1 pkg2`。此规则需写入 Cursor 规则与 AI 开发文档，供 Cursor 牢记。

### 1.2 AI Chat 与 Ant Design X

- **AI Chat 部分**（剧情大纲中的漫剧剧本专家 Chat、视频设计器列 4 的 AI Chat）必须使用 **Ant Design X** 构建。
- Ant Design X 包含 3 个包，需一并接入（参考 [Ant Design X 介绍](https://ant-design-x.antgroup.com/docs/react/introduce-cn)）：
  - **`@ant-design/x`**：智能界面构建框架，基于 Ant Design 的 AI 驱动 UI 组件（对话、输入等）。
  - **`@ant-design/x-markdown`**：流式 Markdown 渲染引擎，用于流式展示 AI 回复。
  - **`@ant-design/x-sdk`**：AI 对话数据流管理，简化对话状态与 API 对接。
- 安装时按 1.1 规则执行：先设置代理，再 `yarn add @ant-design/x @ant-design/x-markdown @ant-design/x-sdk`。

### 1.3 参考项目（项目管理、路由、主题、Tailwind）

- 以下实现可参考本地项目 **`/Users/yanfang/dev/Biezhi2/web`**（非拷贝，仅作结构与配置参考）：
  - **路由**：React Router v6（`BrowserRouter`、`Routes`、`Route`），在根组件内包裹 Layout 与 Content。
  - **Ant Design 主题**：在入口（如 `main.tsx`）使用 `ConfigProvider`，`theme={{ algorithm: theme.darkAlgorithm, ...customTheme }}`，locale 使用 `zh_CN`。
  - **Tailwind CSS**：Tailwind v4 + PostCSS（`@tailwindcss/postcss`、`autoprefixer`），`tailwind.config.ts` 中 content 包含 `./index.html` 与 `./src/**/*.{js,ts,jsx,tsx}`，全局样式在 `index.css` 中 `@import "tailwindcss"`。
  - **项目结构**：`src/pages` 页面组件、`src/components` 公共组件、`src/contexts`、`src/hooks`、`src/services`、`src/utils` 等按职责划分。
- 芝绘为 Electron 应用，入口与 Biezhi2 的 Web 不同（Electron 主进程加载渲染进程的 Vite 输出），但渲染进程内的 React 路由、Ant Design 与 Tailwind 配置方式可参考上述项目。

---

## 2. 主题与 UI 约定

- **Ant Design**：通过 ConfigProvider 配置为 **dark 主题**，全应用统一，不提供主题切换（首版）。
- **布局**：漫剧视频设计器采用 Ant Design **Splitter** 实现列/行可 Resize，具体见功能文档中的**三列 + 时间线面板**布局与术语表（舞台、播放器面板、渲染区、时间线、素材条、选中时间轴、素材面板、功能面板等）。

---

## 3. 数据与存储

### 3.1 应用级 SQLite（首次打开时初始化）

- **用途**：管理「本机所有漫剧项目」的基础信息。
- **时机**：应用第一次成功打开时，在用户可配置或默认的应用数据目录下创建/初始化该库。
- **主要内容**（逻辑上，具体表结构在开发阶段设计）：
  - 项目列表：名称、横竖屏、本地项目目录（唯一）、封面路径、创建时间、更新时间等。
  - 可选：最近打开项目、窗口布局等轻量配置。
- **访问方式**：仅主进程或主进程提供的 API 访问，渲染进程通过 IPC 读写。

### 3.2 项目级 SQLite（每个项目一个）

- **时机**：用户「新建项目」并确认本地项目目录后，在该目录下创建项目级 SQLite。
- **用途**：保存该漫剧项目的全部业务数据，与「项目资源文件」同目录，便于备份、迁移、版本管理。
- **主要内容**（逻辑上）：
  - 项目元信息（名称、横竖屏、封面等，可与应用级列表冗余以便离线或目录移动后仍可读）。
  - 剧情大纲（集、概要、剧本文本等）。
  - 人物设计（人物列表、形象引用、默认 TTS 参数等）。
  - AI 配置（剧本专家、绘画的自定义要求）。
  - 漫剧视频设计器数据：场景、镜头、分层、时间轴、素材块、关键帧、对象运动与状态等。
  - 素材库索引（素材分类、路径、类型、Package 的 YAML 路径等；大文件本身存于项目目录下的资源文件夹）。
- **访问方式**：由主进程或项目打开时注入的上下文统一访问，渲染进程通过 IPC 或预加载脚本封装的 API 调用。

### 3.3 项目资源目录约定

- 项目根目录下约定结构（见开发计划 2.4）：`project.db`（项目级 SQLite）、`assets/`（素材文件）、`exports/`（导出输出）、`ai-cache/`（AI 生成缓存）。路径与 SQLite 中引用一致。

---

## 4. 画布与渲染

### 4.1 技术路线选择

- **是否使用 Canvas**：画布可能使用 Canvas 2D 或保留 DOM + CSS 方案，需在实现时评估：
  - 若使用 Canvas：需考虑**透明视频**（带 Alpha 通道）的解码与绘制能力（如支持 PNG 序列或 WebM 等带透明通道的格式）。
  - 若使用 DOM：透明视频可通过 `<video>` 与合成方式实现，但大量对象时需关注性能。
- **结论**：在技术预研阶段确定「画布实现方式」与「透明视频支持方案」，并在开发计划中体现；无论哪种方式，都必须**支持透明视频素材**的显示与导出。（产品已同意：可采用 DOM + `<video>` 透明视频方案；坐标与尺寸采用与画布成比例表述，见 4.2。）

### 4.2 坐标与尺寸单位

- 画布内素材的**位置、缩放、旋转**不建议使用纯 px（与分辨率强绑定），应使用**与画布尺寸成比例**的表述，例如：
  - 归一化坐标（0–1）或百分比（%）存储，渲染时按画布实际宽高换算；
  - 或使用「设计稿宽高」为基准的虚拟单位，导出时再映射到目标分辨率。
- **注意**：直接使用 CSS `%` 在复杂变换（旋转、非等比缩放）下可能存在兼容性或行为差异，需要在实现时验证；若有问题，采用「存储百分比/归一化数值，渲染时转换为 px」更稳妥。（产品已同意：位置/缩放/旋转采用与画布尺寸成比例的表述，优先归一化或百分比存储，渲染时换算。）

### 4.3 分层与主轨道（见功能文档 6.7）

- **layers 表**：含 `is_main` 字段（0/1），标识**主分层**。场景初始化时创建的主分层 `is_main=1`。
- **主分层**：不可删除；其轨道支持 sortable；其他分层仅为 droppable + draggable。
- **主分层与显示顺序**：由 `is_main` 标识，与 `z_index`（上下顺序）无关。

### 4.4 时间线轨道与素材条 DOM 结构

- **轨道**：每条时间线轨道为 `position: relative` 容器，其内素材条使用 `position: absolute` 定位。主轨道（is_main=1）的素材条使用 SortableContext + horizontalListSortingStrategy。
- **素材条**：`left` 与 `width` 由 `start_time`、`end_time` 换算为像素；主轨道无空隙，非主轨道可有空隙。
- **关键帧**：关键帧与素材条关联，DOM 放在**素材条内部**；关键帧使用 `position: absolute`，`left` 可为**百分比**（相对于素材条的 start_time～end_time 区间）。
- **关键帧补间**：位置/平面旋转/3D旋转/缩放在渲染时使用一个 Transform 组合；关键帧之间按时间线性插值（补间）；模糊/透明度/色彩单独插值。实现见 `src/utils/keyframeTween.ts`。

---

## 5. 视频导出

### 5.1 能力目标

- 将当前集（或选定集）的「分层 + 时间轴 + 关键帧」合成为视频文件。
- 支持透明视频素材、图片、文字、音频（对白、声效、音乐）的合成。
- 输出格式、分辨率、帧率在首版可固定或少量选项（如 MP4、与项目横竖屏一致的分辨率）。

### 5.2 技术选项

- **是否依赖 ffmpeg**：主进程使用 fluent-ffmpeg 调用 ffmpeg 进行编码。ffmpeg 分发策略（见开发计划 2.13）：
  - 若安装 `ffmpeg-static`，使用其内置二进制；
  - 否则使用系统 PATH 的 ffmpeg，需用户自行安装。
- **导出流水线**：先由前端或主进程按时间轴生成「帧序列 + 音频」，再交给 ffmpeg 合成；或使用支持透明通道的编码流程（如 PNG 序列 + 单独音轨再封装）。具体在实现阶段设计，技术文档仅要求：**支持透明视频素材参与合成，并考虑使用 ffmpeg 进行压缩与格式转换**，除非选型明确采用其他方案。

---

## 6. 素材包（Package）与 YAML

- **格式**：每个素材包目录内包含一个 YAML 文件，描述该包的元信息、状态映射、Tag 映射等（见功能文档）。
- **解析**：在主进程或渲染进程（若性能允许）中解析 YAML，建议使用稳定的 JS/TS 库（如 js-yaml），避免手写解析。
- **与 SQLite 关系**：项目库中可只存「包路径 + YAML 路径」及缓存后的状态/Tag 列表，详细资源由运行时按 YAML 加载；若 YAML 变更，需有刷新或重新解析策略。

---

## 7. 进程与安全

- **Electron**：主进程负责 SQLite、文件系统、原生模块（如 ffmpeg 调用）、系统对话框等；渲染进程仅负责 UI 与业务逻辑，通过 **contextBridge + 预加载脚本** 暴露有限 API，禁止直接暴露 Node 或 Electron 全量 API。
- **敏感信息**：AI API 密钥等仅存于用户可控位置（如应用配置目录或项目级加密配置），不提交到版本库。

---

## 8. 与功能文档的对应关系

- **功能文档** 中的「漫剧项目列表、设置、剧情大纲、人物设计、AI 配置、视频设计器、素材体系」等，其持久化与状态管理均依赖上述「应用级 SQLite + 项目级 SQLite + 项目资源目录」。
- **画布单位、透明视频、视频导出与 ffmpeg** 等在本技术文档中给出约束与方向，具体实现细节在开发计划与编码阶段落实。
- **Ant Design 仅 dark 主题、布局使用 Splitter** 等与功能文档中的 UI 描述一致；**术语**（舞台、播放器面板、渲染区、时间线、素材条、选中时间轴、素材面板、功能面板、本地素材、预设素材、元件组）以功能文档 1.1 为准；**用户习惯**（设计器 Toggle、默认 Tab、默认剧集/场景）持久化到 localStorage。

---

## 9. 文档修订说明

- 技术选型表、主题与 UI、数据存储、画布与单位、视频导出、素材 YAML、进程与安全等均以「要求与约束」为主，不包含具体代码或表结构。
- 画布是否用 Canvas、单位用 % 还是归一化、导出是否用 ffmpeg 等，均保留了「待实现时确定」的说明，避免过度承诺，便于后续在开发计划中拆任务。
