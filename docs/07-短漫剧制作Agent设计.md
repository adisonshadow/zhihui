# 芝绘 - 短漫剧制作 Agent 设计文档

本文档设计芝绘应用中用于**帮助用户快速制作短漫剧**的 Agent 系统，包括 Agent 的定位、能力边界、用户诉求理解、短漫剧领域知识、应用工具集，以及基于火山引擎大模型服务的开发方案。

---

## 1. Agent 定位与目标

### 1.1 核心定位

**短漫剧制作 Agent** 是用户在芝绘中创作漫剧时的智能协作伙伴，能够：

- 理解用户想要讲述的故事或表达的创意
- 在**编剧、分镜、素材制作、视频合成**全流程中提供建议与执行支持
- 利用本应用的**工具集**（剧情大纲、人物设计、视频设计器等）完成任务
- 明确告知能力边界，对无法完成的任务给出替代建议

### 1.2 设计目标

| 目标 | 说明 |
|------|------|
| **快速** | 减少用户在「想」与「做」之间的摩擦，快速产出可用的剧本、分镜、素材 |
| **高效** | 理解短漫剧特点，一次生成即贴近可用，减少反复修改 |
| **边界清晰** | Agent 知道「能做什么」「不能做什么」，避免过度承诺 |
| **工具驱动** | 通过 Function Calling 调用应用工具，而非仅输出建议文本 |

---

## 2. Agent 能力边界

Agent 应明确知晓自身与应用的**能力范围**，并在与用户对话中体现。

### 2.1 可直接执行的能力

| 能力 | key | 说明 | 依赖 |
|------|-----|------|------|
| **编剧** | script | 生成/修改剧本、概要、场景、对白、旁白、动作 | 配置了 script 能力的模型 |
| **生成图** | draw | 生成人物形象、场景背景、道具等图片 | 配置了 draw 能力的模型 |
| **抠图** | matting | 对图片执行智能抠图（火山引擎/本地 ONNX） | 已配置抠图服务 |
| **生成精灵图** | sprite | 从图片或线稿生成多帧精灵图 | 配置了 sprite 的模型 + 抠图 |
| **生成骨骼蒙皮** | skeleton_skinning | 为角色生成骨骼蒙皮 | 配置了该能力的模型 |
| **生成动作脚本** | action_script | 生成可驱动骨骼/精灵图的动作指令 | 配置了该能力的模型 |
| **生成配音** | voice_over | TTS 配音 | 配置了 voice_over 的模型 |
| **生成音乐** | music | BGM、氛围音乐 | 配置了 music 的模型 |
| **生成语音特效** | sound_effect | 特效音、情绪音 | 配置了该能力的模型 |
| **生视频** | video | 文本/图生视频 | 配置了 video 的模型 |

> 能力与 `src/types/settings.ts` 中的 `CAPABILITY_TAGS` 一致，见功能文档 3.1。

### 2.2 可建议但需用户操作的能力

| 能力 | 说明 | Agent 行为 |
|------|------|------------|
| **分镜编排** | 镜头运动、关键帧、素材条时长 | 输出结构化建议（如镜头 x/y/zoom、时长），用户在设计器中应用 |
| **导出视频** | 将场景合成为视频文件 | 提醒用户使用「导出视频」按钮，或说明导出参数 |
| **素材分类与管理** | 将素材归入人物/场景/道具等 | 建议用户将某资源保存到某分类 |

### 2.3 明确不具备的能力

| 类别 | 说明 | Agent 回应方式 |
|------|------|----------------|
| **实时预览** | 无法「边改边播」预览成片 | 引导用户在设计器中播放 |
| **第三方服务调用** | 无法直接调用未配置的 API | 建议用户在设置中配置对应模型 |
| **本地文件系统** | 无法随意读写用户磁盘 | 仅通过应用提供的工具操作项目 |
| **超长上下文** | 无法记忆无限历史对话 | 提示用户关键信息在「项目上下文」中 |

### 2.4 能力检查策略

- 执行任务前：根据用户请求，检查当前项目/应用**已配置的能力**（模型配置、抠图配置等）
- 若某能力未配置：明确告知用户「需在设置中配置 xxx 模型」，并给出配置入口说明
- 若某能力由外部服务提供且调用失败：告知具体错误，建议检查密钥、网络等

---

## 3. 用户诉求理解

### 3.1 典型用户诉求类型

| 类型 | 示例 | 理解要点 |
|------|------|----------|
| **创意输入** | 「我想讲一个关于校园霸凌反击的故事」 | 提取题材、主题、情感基调 |
| **结构诉求** | 「帮我写第 2 集，要有反转」 | 识别集/场景、戏剧标签（reversal） |
| **风格诉求** | 「Q 版、古风、悬疑氛围」 | 画风、题材、基调 |
| **效率诉求** | 「快速出第一集分镜」「一键生成人物」 | 优先速度与可用性 |
| **修改诉求** | 「把小明这段台词改搞笑点」「场景 2 加个钩子」 | 精确定位 path（见 短漫剧剧本元素说明 15.10） |
| **素材诉求** | 「生成主角形象」「这个图抠一下」 | 区分生成 vs 处理、单图 vs 序列 |

### 3.2 诉求解析与澄清

- **模糊诉求**：主动追问关键信息（如题材、时长、风格），避免盲目生成
- **复杂诉求**：拆解为多个子任务，按「编剧 → 人物 → 分镜 → 素材」顺序执行
- **矛盾诉求**：礼貌指出矛盾并请用户确认优先级

### 3.3 上下文感知

Agent 应能获取并利用：

- **当前项目**：项目名、横竖屏、已有集/场景、人物列表
- **当前焦点**：用户在哪个 Tab（剧情大纲 / 人物设计 / 视频设计器）、选中的集/场景
- **已有内容**：当前集的概要/剧本、当前场景的素材条、人物形象等

---

## 4. 短漫剧特点（领域知识）

Agent 需内化短漫剧的创作特点，并在生成与建议中体现。

### 4.1 形式特点

| 特点 | 说明 | Agent 应用 |
|------|------|------------|
| **快速** | 单集时长短（1–数分钟），用户期待快速看完、快速制作 | 剧本不宜过长，场景数量适中，单场景时长可控 |
| **高效讲故事** | 信息密度高，少废话，直奔主题 | 对白精简，旁白画龙点睛，动作说明简洁 |
| **节奏快** | 快切、强节奏，避免拖沓 | 场景转换干脆，镜头建议偏短 |
| **爽点多** | 反转、冲突、高潮、钩子要足 | 主动为场景打 dramaTags，建议每集末尾有钩子 |
| **竖屏优先** | 多数短漫剧为竖屏观看 | 注意画布比例，构图建议适合竖屏 |

### 4.2 剧本结构

- 遵循 `docs/短漫剧剧本元素说明.md` 第 15 节：Script → Episode → Scene → Dialogue/Narration/Action
- 戏剧标签（dramaTags）：suspense、hook、conflict、reversal、climax 等，见 `src/types/script.ts`
- 对白、旁白、动作分离存储，便于 TTS 与分镜绑定

### 4.3 素材体系

- 分类：人物、场景背景、情景道具、声效、透明视频特效、音乐、贴纸（功能文档 5.1）
- 素材包：支持状态与 Tag 映射（功能文档 5.3）

---

## 5. 本应用工具集（Tools）

Agent 通过 **Function Calling** 调用应用提供的工具，实现「说即所做」。

### 5.1 工具列表（建议实现顺序）

| 工具名 | 说明 | 参数示例 | 返回值 |
|--------|------|----------|--------|
| `get_project_context` | 获取当前项目上下文 | projectId | 项目信息、集列表、人物列表、当前选中集/场景 |
| `get_episode_content` | 获取指定集的概要与剧本 | projectId, episodeIndex | 概要、剧本文本、结构化剧本 |
| `update_episode_content` | 更新集的概要或剧本 | projectId, episodeIndex, summary?, scriptText?, scriptJson? | ok/error |
| `create_episode` | 新建一集 | projectId, title?, summary? | episodeId/error |
| `generate_script` | 调用剧本模型生成剧本 | projectId, episodeIndex?, prompt, style? | 生成的剧本 JSON 或文本 |
| `get_characters` | 获取项目人物列表 | projectId | 人物 id、名称、形象路径等 |
| `generate_character_image` | 调用绘图模型生成人物形象 | projectId, characterId?, prompt, style? | 图片路径/error |
| `list_assets` | 列出项目素材 | projectId, category? | 素材列表 |
| `matting_image` | 对图片执行抠图 | imagePath, configId? | 抠图后图片路径 |
| `get_scene_timeline` | 获取场景时间线信息 | projectId, episodeIndex, sceneIndex | 素材条、分层、关键帧等 |
| `suggest_camera` | 生成镜头建议（不直接写入） | projectId, episodeIndex, sceneIndex | 镜头 x/y/zoom 等建议 |

### 5.2 工具与能力映射

- `generate_script` → 需配置 script 能力模型
- `generate_character_image` → 需配置 draw 能力模型
- `matting_image` → 需配置抠图服务（火山引擎或本地）
- 其他工具为应用内数据读写，不依赖外部模型

### 5.3 工具调用流程

1. 用户发送消息
2. Agent（大模型）解析意图，决定是否调用工具及调用哪些工具
3. 应用执行工具，返回结果
4. Agent 将结果整合后回复用户，必要时继续调用工具

---

## 6. 火山引擎大模型服务接入

### 6.1 服务选型

| 场景 | 推荐服务 | 说明 |
|------|----------|------|
| Agent 主模型（文本理解、规划、Function Calling） | 火山方舟 / 豆包大模型 | ChatCompletions API，支持 Function Calling |
| 剧本生成 | 同上，或专用剧本模型 | 可复用主模型，也可按能力 tag 路由到 script 模型 |
| 绘图 | Seedream 等 | 火山引擎图片生成（若选用火山系绘图） |

参考文档：
- [火山方舟快速入门](https://www.volcengine.com/docs/82379/1399008)
- [豆包模型服务协议](https://www.volcengine.com/docs/82379/1142195)
- [函数调用 Function Calling](https://www.volcengine.com/docs/82379/1262342)
- [模型列表](https://www.volcengine.com/docs/82379/1554711)

### 6.2 接入方式

**方案 A：OpenAI 兼容接口**

- 火山方舟提供 OpenAI 兼容的 Chat Completions API
- 芝绘当前剧本专家已使用 `OpenAIChatProvider` + `XRequest`（见 `OutlineTab.tsx`）
- 若火山方舟提供兼容 endpoint，仅需在「添加模型」时配置：
  - API 地址：火山方舟 Chat 兼容 URL
  - API Key：火山方舟 API Key / Token
  - Model：对应模型 ID（如豆包模型 endpoint_id）

**方案 B：火山方舟原生 SDK**

- 使用火山引擎提供的 Node.js/TypeScript SDK
- 需新增 `electron/main/volcengineLLMService.ts`，封装：
  - 认证（API Key 或 Access Key + 签名）
  - Chat Completions 请求
  - Function Calling 的 tools / tool_calls 处理
  - 流式输出

### 6.3 配置管理

- 在「设置」-「AI 模型配置」中，支持 `provider: 'volcengine'` 类型
- 配置项：API 地址、API Key（或 Access Key ID + Secret）、模型 ID
- 与现有 OpenAI 兼容模型共用同一配置表，通过 `provider` 或 `apiUrl` 区分

### 6.4 Function Calling 与火山引擎

- 火山方舟支持 Function Calling（工具调用）
- 需将本应用工具集定义为 `tools` 数组，按火山方舟/OpenAI 的 schema 格式传入
- 模型返回 `tool_calls` 时，应用执行对应工具并将结果放入下一轮 messages

---

## 7. Agent 系统提示词（System Prompt）设计

### 7.1 角色定义

```
你是芝绘（Yiman）的短漫剧制作助手。芝绘是一款用于快速开发 2D 短漫剧的桌面应用。
你的任务是帮助用户在剧情大纲、人物设计、视频设计器等模块中高效完成创作。
```

### 7.2 能力与边界

```
你知道以下能力（具体是否可用取决于用户配置）：
- 编剧：生成/修改剧本、概要、场景、对白、旁白、动作
- 生成图：人物形象、场景、道具
- 抠图、精灵图、骨骼蒙皮、动作脚本
- 配音、音乐、语音特效
- 生视频

你无法：随意读写用户磁盘、调用未配置的服务、实时预览成片。
若用户请求超出能力，应明确说明并建议替代方案。
```

### 7.3 短漫剧知识

```
短漫剧特点：快速、高效讲故事、节奏快、爽点多。单集时长短，信息密度高。
剧本结构：集 → 场景 → 对白/旁白/动作。支持戏剧标签（悬念、钩子、冲突、反转、高潮等）。
```

### 7.4 工具使用

```
你可以通过调用工具来完成任务。在调用前，请确认：
1. 工具所需参数是否具备
2. 对应能力是否已配置
若工具调用失败，向用户说明原因并建议下一步。
```

### 7.5 回复风格

```
- 简洁、直接，避免冗长
- 生成内容时，优先保证「可用」，再考虑「完美」
- 对修改类请求，精确定位到集/场景/对白等，避免模糊
```

---

## 8. 开发路线建议

### 8.1 阶段一：基础接入

1. 在设置中支持火山引擎大模型配置（API 地址、Key、模型 ID）
2. 实现 `volcengineLLMService` 或确认 OpenAI 兼容方式可用的配置
3. Agent Chat 使用与剧情大纲剧本专家相同的 Ant Design X 三件套，替换为 Agent 专用 Provider

### 8.2 阶段二：工具集

1. 实现 `get_project_context`、`get_episode_content`、`update_episode_content` 等只读/写入工具
2. 定义 tools schema，接入 Function Calling
3. Agent 能根据用户诉求调用工具并整合结果

### 8.3 阶段三：能力整合

1. 实现 `generate_script`、`generate_character_image` 等调用已配置模型的工具
2. 能力检查逻辑：执行前检查模型配置
3. 抠图、精灵图等与现有服务（volcengineMattingService、spriteService）打通

### 8.4 阶段四：体验优化

1. 上下文窗口管理（项目数据、对话历史）
2. 流式输出 + 工具调用穿插的展示
3. 错误处理与用户提示的完善

---

## 9. 与现有模块的关系

| 现有模块 | Agent 关系 |
|----------|------------|
| 剧情大纲 + 漫剧剧本专家 | Agent 可替代或增强剧本专家，通过工具写回剧本 |
| 人物设计 + AI 绘画 | Agent 可调用绘图工具生成形象并绑定人物 |
| AI 配置（项目级） | Agent 的剧本/绘画风格可读取项目级自定义要求 |
| 视频设计器 AI Chat | 可与 Agent 合并或作为 Agent 在同一 Chat 中的不同「角色」 |
| 设置 - AI 模型配置 | Agent 依赖此处配置的模型与能力 tag |

---

## 10. 参考文档

- `docs/01-功能文档.md`：需求与术语
- `docs/02-技术文档.md`：技术约束
- `docs/短漫剧剧本元素说明.md`：剧本结构与 dramaTags
- `src/types/script.ts`：剧本实体类型
- `src/types/settings.ts`：能力 tag、模型配置
- 火山方舟：https://www.volcengine.com/docs/82379
