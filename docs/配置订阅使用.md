# 配置订阅使用

本文档说明如何在应用内使用**配置订阅模式**：配置面板可在任意界面以 Modal 形式打开，配置修改后根据订阅记录通知被订阅方。

## 1. 核心概念

- **配置面板**：AI 模型配置等全局设置，以 Modal 形式打开，可从任意界面（项目列表、项目编辑、设计器等）唤起。
- **订阅**：业务模块通过 `useConfigSubscribe` 订阅配置变化；配置保存成功后，所有订阅者会收到最新配置并重新渲染。
- **数据流**：主进程持久化 → 渲染进程获取 → 订阅者持有最新副本；保存时写回主进程 → 主进程确认 → 通知所有订阅者更新。

## 2. 打开配置面板

在任何组件中调用：

```tsx
import { useConfigModal } from '@/contexts/ConfigContext';

function MyComponent() {
  const { openConfigModal } = useConfigModal();

  return (
    <Button onClick={() => openConfigModal()}>
      打开设置
    </Button>
  );
}
```

配置面板会以 Modal 形式覆盖在当前页面上，用户关闭 Modal 后留在当前界面。

## 3. 订阅配置变化

需要消费 AI 配置的模块（如剧情大纲剧本专家、人物设计绘画、视频设计器 AI Chat 等）应订阅配置，以便在用户修改配置后自动使用最新值：

```tsx
import { useConfigSubscribe } from '@/contexts/ConfigContext';

function ScriptExpertChat() {
  const config = useConfigSubscribe();

  if (!config) return <Text type="secondary">加载配置中…</Text>;

  // 按能力筛选：如需要「生成剧本」能力的模型
  const scriptModels = config.models.filter((m) =>
    m.capabilityKeys.includes('script')
  );

  if (scriptModels.length === 0) {
    return (
      <Text type="secondary">
        请在「设置」中配置具备「生成剧本」能力的模型。
      </Text>
    );
  }

  // 使用 scriptModels[0] 或让用户选择
  const apiUrl = scriptModels[0].apiUrl;
  const apiKey = scriptModels[0].apiKey;
  // ...
}
```

## 4. API 说明

### `useConfigModal()`

返回 `{ openConfigModal: () => void }`，用于打开配置 Modal。

### `useConfigSubscribe()`

订阅配置变化，返回当前最新配置 `AISettings | null`。配置加载中为 `null`，加载完成或更新后为 `AISettings`。配置保存成功后，所有调用 `useConfigSubscribe` 的组件都会收到最新 `AISettings` 并重新渲染。

### `useConfig()`（可选）

若仅需读取当前配置、不强制跟随更新，可使用 `useConfig()`。推荐需要「配置变化后立即生效」的场景使用 `useConfigSubscribe`。

## 5. 能力 tag 与模型筛选

调用 AI 时，按所需能力筛选模型：

| 能力 key        | 说明           | 典型使用场景           |
| --------------- | -------------- | ---------------------- |
| script          | 生成剧本       | 剧情大纲剧本专家       |
| draw            | 绘图           | 人物设计、场景绘画     |
| matting         | 抠图           | 精灵图抠图、素材处理   |
| sprite          | 生成精灵图     | 精灵图生成             |
| skeleton_skinning | 生成骨骼蒙皮 | 骨骼绑定、蒙皮         |
| action_script   | 生成动作脚本   | 角色动作               |
| voice_over      | 生成配音       | TTS 对白               |
| music           | 生成音乐       | 背景音乐               |
| sound_effect    | 生成语音特效   | 音效                   |
| exec_script     | 生成执行脚本   | 自动化脚本             |
| video           | 生视频         | 视频生成               |

```ts
const modelsForDraw = config.models.filter((m) =>
  m.capabilityKeys.includes('draw')
);
```
