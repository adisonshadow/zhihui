# 素材动画功能 - 技术方案

## 1. 功能概述

在漫剧视频设计器中，为**非音效/音乐**的素材提供动画能力。选中素材后，在功能面板中新增「动画」入口，支持配置**出现**、**动作**、**消失**三类动画，并在画布播放与时间线上体现。

**参考**：功能文档 6.6、6.8；技术文档 4；[Magic Animations CSS3](https://www.minimamente.com/project/magic/)

---

## 2. 需求要点

### 2.1 入口与展示

- **条件**：选中素材且**不是**音效/音乐时，在选中素材设置中多一个「动画」item。
- **结构**：点击进入后，分为 3 个 Tab：**出现**、**动作**、**消失**。
- **未配置**：某 Tab 下若尚未配置动画，显示「添加动画」按钮。
- **已配置**：
  - 行 1：**变更**按钮、**预览**按钮；变更点击后再次打开动画选择面板，已选中有标记。
  - 行 2：动画设置（时长、动作的运行次数、方向等额外参数）。

### 2.2 动画选择面板

- **形式**：无 mask 的 Drawer（`mask={false}`）。
- **内容**：列表，每项包含：动画名称（中文）、预览、使用按钮。
- **已选**：再次打开时，当前选中的动画有标记。

### 2.3 动画设置

| 类型   | 时长 | 运行次数 | 额外参数示例           |
|--------|------|----------|------------------------|
| 出现   | ✓ 有默认值 | 固定 1 次 | 飞入方向等             |
| 动作   | ✓ 有默认值 | 可配置多次 | 方向、循环方式等       |
| 消失   | ✓ 有默认值 | 固定 1 次 | 飞出方向等             |

### 2.4 画布播放

- 画布播放时，素材需按配置执行对应动画效果。

### 2.5 时间线标识

- 素材条顶部显示一条**高度 2px、顶到最上**的橙色线段，表示该素材有动画配置。

---

## 3. 动画来源与扩展性

### 3.1 当前阶段

- 使用 [Magic Animations CSS3](https://www.minimamente.com/project/magic/)（`public/magic.css`）。
- 动画需按**出现**、**动作**、**消失**分类，部分可重叠。
- 显示名称使用**中文**。
- **同类动作**（如 slide、space、perspective 等）提取为参数化，方向作为参数，避免重复定义。

### 3.2 扩展性要求

- **禁止写死**：后续会引入其他动画库（如 Animate.css、自定义 keyframes 等）。
- 采用**动画注册表（Registry）**模式：各动画库通过统一接口注册，UI 与数据层只依赖注册表，不依赖具体库。

---

## 4. 动画注册表设计

### 4.1 核心类型

```ts
/** 动画分类：出现 / 动作 / 消失 */
export type AnimationCategory = 'appear' | 'action' | 'disappear';

/** 动画定义（来自某动画库） */
export interface AnimationDef {
  /** 唯一 ID，建议格式：库名.类名，如 magic.puffIn */
  id: string;
  /** 中文显示名 */
  label: string;
  /** 分类，可多选（如 slide 可同时用于出现/消失） */
  categories: AnimationCategory[];
  /** CSS 类名（不含 magictime，由运行时拼接） */
  cssClass: string;
  /** 所属动画库标识，用于加载对应 CSS */
  libraryId: string;
  /** 默认时长（秒） */
  defaultDuration: number;
  /** 是否支持方向参数（如 up/down/left/right），有则用 param 选择具体类名 */
  hasDirectionParam?: boolean;
  /** 方向与类名映射，如 { up: 'spaceInUp', down: 'spaceInDown' } */
  directionMap?: Record<string, string>;
  /** 其他参数 schema（后续扩展） */
  paramsSchema?: Record<string, unknown>;
}

/** 素材块上的动画配置 */
export interface BlockAnimationConfig {
  /** 出现动画 */
  appear?: {
    animationId: string;
    duration: number;
    direction?: string;
    [key: string]: unknown;
  };
  /** 动作动画（可循环） */
  action?: {
    animationId: string;
    duration: number;
    repeatCount: number; // 1=一次，0 或 -1 表示无限（可选）
    direction?: string;
    [key: string]: unknown;
  };
  /** 消失动画 */
  disappear?: {
    animationId: string;
    duration: number;
    direction?: string;
    [key: string]: unknown;
  };
}
```

### 4.2 Magic.css 动画分类与参数化

以下为 Magic 库的归类与参数化建议，**通过注册表注册**，不硬编码在业务逻辑中。

#### 出现（Appear）

| 注册 ID | 中文名 | 原类名 | 说明 |
|---------|--------|--------|------|
| magic.puffIn | 膨胀出现 | puffIn | |
| magic.vanishIn | 模糊出现 | vanishIn | |
| magic.swap | 交换出现 | swap | |
| magic.twisterInDown | 扭转出现（下） | twisterInDown | |
| magic.twisterInUp | 扭转出现（上） | twisterInUp | |
| magic.foolishIn | 弹跳出现 | foolishIn | |
| magic.swashIn | 水花出现 | swashIn | |
| magic.boingInUp | 弹跳出现（上） | boingInUp | |
| magic.spaceIn | 空间飞入 | - | 参数化，direction: up/down/left/right → spaceInUp 等 |
| magic.perspectiveReturn | 透视出现 | - | 参数化，direction → perspectiveDownReturn 等 |
| magic.slideReturn | 滑入 | - | 参数化，direction → slideDownReturn 等 |
| magic.openReturn | 展开出现 | - | 参数化，direction → openDownLeftReturn 等 |
| magic.tinIn | 收缩出现 | - | 参数化，direction → tinDownIn 等 |

#### 动作（Action）

| 注册 ID | 中文名 | 原类名 | 说明 |
|---------|--------|--------|------|
| magic.magic | 魔法旋转 | magic | 缩小旋转消失，可作动作 |
| magic.rotate | 旋转 | - | 参数化，direction → rotateDown 等 |
| magic.perspective | 透视翻转 | - | 参数化，direction → perspectiveDown 等 |
| magic.slide | 滑动 | - | 参数化，direction → slideDown 等 |
| magic.open | 展开 | - | 参数化，direction → openDownLeft 等 |

#### 消失（Disappear）

| 注册 ID | 中文名 | 原类名 | 说明 |
|---------|--------|--------|------|
| magic.puffOut | 膨胀消失 | puffOut | |
| magic.vanishOut | 模糊消失 | vanishOut | |
| magic.bombOut | 爆炸消失 | - | 参数化，direction: left/right → bombLeftOut 等 |
| magic.foolishOut | 弹跳消失 | foolishOut | |
| magic.holeOut | 洞穿消失 | holeOut | |
| magic.swashOut | 水花消失 | swashOut | |
| magic.boingOutDown | 弹跳消失（下） | boingOutDown | |
| magic.spaceOut | 空间飞出 | - | 参数化，direction → spaceOutUp 等 |
| magic.perspective | 透视消失 | - | 与动作共用，direction → perspectiveDown 等 |
| magic.openOut | 收起消失 | - | 参数化，direction → openDownLeftOut 等 |
| magic.tinOut | 收缩消失 | - | 参数化，direction → tinDownOut 等 |

### 4.3 注册表实现

```ts
// src/constants/animationRegistry.ts
const registry: AnimationDef[] = [];

export function registerAnimation(def: AnimationDef) {
  registry.push(def);
}

export function getAnimationsByCategory(cat: AnimationCategory): AnimationDef[] {
  return registry.filter((d) => d.categories.includes(cat));
}

export function getAnimationById(id: string): AnimationDef | undefined {
  return registry.find((d) => d.id === id);
}
```

Magic 库的动画在 `src/constants/animationsMagic.ts` 中定义并调用 `registerAnimation` 注册，与业务逻辑解耦。

---

## 5. 数据模型

### 5.1 timeline_blocks 扩展

新增列 `animation_config`（TEXT，JSON）：

```json
{
  "appear": { "animationId": "magic.puffIn", "duration": 0.6 },
  "action": { "animationId": "magic.rotate", "duration": 1, "repeatCount": 2, "direction": "up" },
  "disappear": { "animationId": "magic.vanishOut", "duration": 0.5 }
}
```

- 通过 `ALTER TABLE` 迁移添加。
- 空或 null 表示无动画。

### 5.2 迁移

在 `projectDb` 的 `ensureTimelineBlocksColumns` 中增加对 `animation_config` 的检测与添加。

---

## 6. UI 结构

### 6.1 功能面板入口

- `BlockSettingsTab` 增加 `'animation'`。
- 非音效/音乐时，header 增加「动画」Tab，与「基础设置」「精灵图设置」并列。
- 选中「动画」后，展示 `AnimationSettingsPanel`。

### 6.2 AnimationSettingsPanel

- 3 个子 Tab：出现、动作、消失。
- 每个子 Tab：
  - 未配置：显示「添加动画」按钮。
  - 已配置：行 1 为「变更」「预览」；行 2 为动画设置表单（时长、运行次数、方向等）。

### 6.3 AnimationPickerDrawer

- `Drawer`，`mask={false}`。
- 列表项：动画名称（中文）、预览区（小方块 + 动画预览）、「使用」按钮。
- 已选中的动画项有视觉标记（如边框/背景色）。
- 支持方向参数的动画，在选中后于设置表单中展示方向选择。

### 6.4 预览

- 「预览」按钮：在独立小画布或弹层中，用占位图执行当前配置的动画，便于快速查看效果。

---

## 7. 画布播放逻辑

### 7.1 时间轴关系

- 素材块时间范围：`[start_time, end_time]`。
- **出现**：在 `start_time` 起，持续 `appear.duration` 秒。
- **动作**：在出现结束后开始，可循环 `repeatCount` 次，每次 `action.duration` 秒。
- **消失**：在 `end_time - disappear.duration` 起，持续 `disappear.duration` 秒。

若未配置某类动画，则跳过；若时长超出块范围，按块边界裁剪。

### 7.2 动画应用方式

- 画布中素材块使用 DOM 渲染时，根据 `currentTime` 判断当前应处于「出现中」「动作中」「消失中」或「静态」。
- 动态添加/移除对应 CSS 类（如 `magictime` + 具体动画类），并通过内联 `animation-duration` 覆盖默认时长。
- 需注意：Magic 的 `magictime` 默认 1s，需用 `style.animationDuration` 覆盖为配置的秒数。

### 7.3 Canvas 组件改动

- `BlockItem` 增加 `animationConfig?: BlockAnimationConfig`。
- `CanvasContainer` 从 block 数据中传入 `animationConfig`。
- 渲染时，根据 `currentTime` 与 `animationConfig` 计算当前动画状态，应用对应类名与 duration。

---

## 8. 时间线素材条

### 8.1 橙色线段

- 在 `TimelineBlockDraggable` 内，若该 block 存在任意 `animation_config`（appear/action/disappear 任一非空），则在素材条**顶部**绘制一条：
  - 高度 2px
  - 顶到最上（`top: 0`）
  - 颜色：橙色（如 `#ff7a00` 或 `rgba(255,122,0,0.9)`）
  - 宽度与素材条一致

### 8.2 数据传递

- `TimelinePanel` 获取 block 时需包含 `animation_config`。
- 将 `hasAnimation` 或 `animationConfig` 传给 `TimelineBlockDraggable`。

---

## 9. 语义化 class 速查

| 组件 | class | 说明 |
|------|-------|------|
| AnimationPickerDrawer | `animation-picker-drawer` | Drawer 根 |
| | `animation-picker-drawer__list` | 动画列表 |
| | `animation-picker-drawer__item` | 列表项 |
| | `animation-picker-drawer__item--selected` | 已选中项 |
| | `animation-picker-drawer__item-header` | 项头部（名称+使用按钮） |
| | `animation-picker-drawer__item-name` | 动画名称 |
| | `animation-picker-drawer__preview-wrap` | 预览容器 |
| | `animation-picker-drawer__preview` | 预览方块 |
| | `animation-picker-drawer__preview-inner` | 预览内层 |
| AnimationSettingsPanel | `animation-settings-panel` | 面板根 |
| | `animation-settings-panel__tabs` | Tabs 容器 |
| AnimationTabContent | `animation-tab-content` | Tab 内容根 |
| | `animation-tab-content--empty` | 未配置态 |
| | `animation-tab-content--configured` | 已配置态 |
| | `animation-tab-content__add-btn` | 添加动画按钮 |
| | `animation-tab-content__actions` | 变更/预览按钮区 |
| | `animation-tab-content__change-btn` | 变更按钮 |
| | `animation-tab-content__preview-btn` | 预览按钮 |
| | `animation-tab-content__settings` | 设置表单区 |
| | `animation-tab-content__duration-input` | 时长输入 |
| | `animation-tab-content__repeat-input` | 运行次数输入 |
| | `animation-tab-content__direction-select` | 方向选择 |
| TimelineBlock | `timeline-block-draggable` | 可拖拽素材条 |
| | `timeline-block-draggable--has-animation` | 有动画的素材条 |
| | `timeline-block-draggable__animation-indicator` | 顶部橙色线段 |
| | `timeline-block-sortable` | 主轨道可排序素材条 |
| | `timeline-block-sortable--has-animation` | 有动画的素材条 |
| | `timeline-block-sortable__animation-indicator` | 顶部橙色线段 |
| Canvas | `canvas-block` | 画布块根 |
| | `canvas-block--animated` | 有动画的块 |
| AnimationPreviewModal | `animation-preview-modal` | 预览 Modal 根 |
| | `animation-preview-modal__stage` | 预览舞台 |
| | `animation-preview-modal__block` | 预览块 |
| | `animation-preview-modal__block-inner` | 预览块内层 |

---

## 10. 文件结构

```
src/
├── constants/
│   ├── animationRegistry.ts      # 注册表
│   └── animationsMagic.ts        # Magic 库动画定义与注册
├── components/
│   ├── designer/
│   │   ├── AnimationSettingsPanel.tsx   # 动画设置主面板（3 Tab）
│   │   ├── AnimationTabContent.tsx      # 单 Tab 内容（添加/变更/设置）
│   │   ├── AnimationPickerDrawer.tsx    # 动画选择 Drawer
│   │   └── AnimationPreviewModal.tsx    # 动画预览 Modal
│   └── ...
├── hooks/
│   └── useBlockAnimation.ts      # 根据 currentTime 计算动画状态（可选）
└── ...
```

---

## 11. 实现顺序建议

1. **动画注册表**：`animationRegistry.ts` + `animationsMagic.ts`，完成 Magic 动画注册与分类。
2. **数据层**：`timeline_blocks` 增加 `animation_config` 列及读写。
3. **AnimationPickerDrawer**：动画选择 Drawer，支持按分类筛选、预览、使用。
4. **AnimationSettingsPanel**：3 Tab 结构，添加/变更/设置表单。
5. **功能面板集成**：在 `SelectedBlockSettings` / `DesignerTab` 中增加「动画」Tab 入口。
6. **画布播放**：在 `Canvas` 中根据 `currentTime` 与 `animationConfig` 应用动画。
7. **时间线标识**：素材条顶部橙色线段。
8. **预览**：预览按钮与预览组件（可后置）。

---

## 12. 与功能文档的对应

- 功能文档 6.6：功能面板中「选中素材设置」增加动画入口。
- 功能文档 6.8：动画作为「素材自带设置」的一部分，与播放时间、对象运动并列。
- 技术文档 4：画布渲染时叠加动画效果，不改变现有坐标与单位体系。

---

## 13. 附录：Magic.css 类名速查

| 分类 | 类名 |
|------|------|
| Bling | puffIn, puffOut, vanishIn, vanishOut |
| Magic | magic, swap, twisterInDown, twisterInUp |
| Math | foolishIn, foolishOut, swashIn, swashOut, holeOut |
| Boing | boingInUp, boingOutDown |
| Bomb | bombLeftOut, bombRightOut |
| Space | spaceInUp/Down/Left/Right, spaceOutUp/Down/Left/Right |
| Perspective | perspectiveDown/Up/Left/Right, perspectiveDown/Up/Left/RightReturn |
| Slide | slideDown/Up/Left/Right, slideDown/Up/Left/RightReturn |
| Open | openDownLeft/Right/UpLeft/UpRight, *Return, *Out |
| Rotate | rotateDown/Up/Left/Right |
| Tin | tinDown/Up/Left/RightIn, tinDown/Up/Left/RightOut |

所有动画需配合 `magictime` 使用，时长通过 `animation-duration` 覆盖。
